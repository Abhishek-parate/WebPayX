<!-- templates/permissions/edit_user_permissions_management.html -->
{% extends 'layout/layout.html' %}
{% block content %}

<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.min.css" rel="stylesheet">

<style>
  .permission-item {
    transition: all 0.3s ease;
  }
  .permission-item:hover {
    background-color: #f9fafb;
  }
  .permission-override {
    border-left: 4px solid #f59e0b;
    background-color: #fffbeb;
  }
  .permission-inherited {
    border-left: 4px solid #10b981;
    background-color: #f0fdf4;
  }
  .permission-denied {
    border-left: 4px solid #ef4444;
    background-color: #fef2f2;
  }
</style>

<!-- Edit User Permissions -->
<div class="container-fluid px-4 py-6">
  
  <!-- Header Section -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">User Permissions</h1>
        <p class="text-gray-600 mt-1">Manage permissions for {{ user.full_name }}</p>
      </div>
      <div>
        <a href="{{ url_for('permissions_management.user_permissions') }}" 
           class="btn bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Users
        </a>
      </div>
    </div>
  </div>

  <!-- User Info Card -->
  <div class="bg-white rounded-lg shadow-md border p-6 mb-6">
    <div class="flex items-center">
      <div class="bg-primary-100 p-4 rounded-full">
        <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </div>
      <div class="ml-6 flex-1">
        <h3 class="text-xl font-semibold text-gray-900">{{ user.full_name }}</h3>
        <p class="text-gray-600">@{{ user.username }}</p>
        <div class="flex items-center mt-2 space-x-4">
          <span class="inline-flex px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
            {{ user.role.value.replace('_', ' ').title() }}
          </span>
          {% if user.email %}
          <span class="text-sm text-gray-500">{{ user.email }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Legend -->
  <div class="bg-white rounded-lg shadow-md border p-6 mb-6">
    <h4 class="font-semibold text-gray-800 mb-4">Permission Status Legend</h4>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="flex items-center">
        <div class="w-4 h-4 bg-green-500 rounded mr-3"></div>
        <span class="text-sm text-gray-700">Inherited from Role (Default behavior)</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-yellow-500 rounded mr-3"></div>
        <span class="text-sm text-gray-700">User Override (Explicitly granted)</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-red-500 rounded mr-3"></div>
        <span class="text-sm text-gray-700">User Override (Explicitly denied)</span>
      </div>
    </div>
  </div>

  <!-- Permissions Form -->
  <form method="POST" action="{{ url_for('permissions_management.update_user_permissions', user_id=user.id) }}" id="userPermissionsForm">
    <div class="bg-white rounded-lg shadow-md border">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800">Permission Overrides</h3>
          <div class="flex gap-2">
            <button type="button" onclick="clearAllOverrides()" 
                    class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
              Clear All Overrides
            </button>
            <button type="button" onclick="grantAll()" 
                    class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
              Grant All
            </button>
            <button type="button" onclick="denyAll()" 
                    class="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
              Deny All
            </button>
          </div>
        </div>
      </div>
      
      <div class="p-6">
        {% set current_category = None %}
        {% for permission in all_permissions %}
          {% if permission.category != current_category %}
            {% if current_category is not none %}
              </div>
            {% endif %}
            {% set current_category = permission.category %}
            <div class="mb-8">
              <h4 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b">
                {{ current_category or 'Uncategorized' }}
              </h4>
              <div class="space-y-3">
          {% endif %}
          
          {% set has_role_permission = role_perms.get(permission.id, False) %}
          {% set user_override = user_perms.get(permission.id) %}
          {% set final_status = user_override if user_override is not none else has_role_permission %}
          
          <div class="permission-item p-4 rounded-lg border
                      {% if user_override == True %}permission-override
                      {% elif user_override == False %}permission-denied
                      {% elif has_role_permission %}permission-inherited
                      {% else %}bg-gray-50{% endif %}">
            
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="font-medium text-gray-900">{{ permission.name }}</div>
                {% if permission.description %}
                <div class="text-sm text-gray-600 mt-1">{{ permission.description }}</div>
                {% endif %}
                
                <!-- Status indicators -->
                <div class="flex items-center mt-2 space-x-4">
                  <div class="text-sm">
                    <span class="text-gray-500">Role Default:</span>
                    <span class="ml-1 {{ 'text-green-600' if has_role_permission else 'text-red-600' }}">
                      {{ 'Granted' if has_role_permission else 'Denied' }}
                    </span>
                  </div>
                  
                  {% if user_override is not none %}
                  <div class="text-sm">
                    <span class="text-gray-500">User Override:</span>
                    <span class="ml-1 {{ 'text-green-600' if user_override else 'text-red-600' }}">
                      {{ 'Granted' if user_override else 'Denied' }}
                    </span>
                  </div>
                  {% endif %}
                </div>
              </div>
              
              <!-- Permission controls -->
              <div class="flex items-center space-x-3">
                <label class="flex items-center">
                  <input type="radio" name="permission_{{ permission.id }}" value=""
                         {% if user_override is none %}checked{% endif %}
                         class="text-gray-500">
                  <span class="ml-2 text-sm text-gray-600">Default</span>
                </label>
                
                <label class="flex items-center">
                  <input type="radio" name="permission_{{ permission.id }}" value="grant"
                         {% if user_override == True %}checked{% endif %}
                         class="text-green-600">
                  <span class="ml-2 text-sm text-green-600">Grant</span>
                </label>
                
                <label class="flex items-center">
                  <input type="radio" name="permission_{{ permission.id }}" value="deny"
                         {% if user_override == False %}checked{% endif %}
                         class="text-red-600">
                  <span class="ml-2 text-sm text-red-600">Deny</span>
                </label>
              </div>
            </div>
          </div>
          
        {% endfor %}
        {% if current_category is not none %}
          </div>
        {% endif %}
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="px-6 py-4 bg-gray-50 border-t flex justify-end space-x-4">
        <button type="button" onclick="resetForm()" 
                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
          Reset
        </button>
        <button type="submit" 
                class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Update Permissions
        </button>
      </div>
    </div>
  </form>

</div>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.all.min.js"></script>

<script>
// SweetAlert Toast Configuration
const Toast = Swal.mixin({
  toast: true,
  position: 'top-end',
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener('mouseenter', Swal.stopTimer)
    toast.addEventListener('mouseleave', Swal.resumeTimer)
  }
})

// Show flash messages
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    document.addEventListener('DOMContentLoaded', function() {
      {% for category, message in messages %}
        Toast.fire({
          icon: '{{ "success" if category == "success" else "error" }}',
          title: '{{ message }}'
        });
      {% endfor %}
    });
  {% endif %}
{% endwith %}

function clearAllOverrides() {
  const defaultRadios = document.querySelectorAll('input[type="radio"][value=""]');
  defaultRadios.forEach(radio => {
    radio.checked = true;
  });
  updatePermissionStyles();
}

function grantAll() {
  const grantRadios = document.querySelectorAll('input[type="radio"][value="grant"]');
  grantRadios.forEach(radio => {
    radio.checked = true;
  });
  updatePermissionStyles();
}

function denyAll() {
  const denyRadios = document.querySelectorAll('input[type="radio"][value="deny"]');
  denyRadios.forEach(radio => {
    radio.checked = true;
  });
  updatePermissionStyles();
}

function resetForm() {
  // Reset to original state
  const originalState = {
    {% for permission in all_permissions %}
    '{{ permission.id }}': {% if user_perms.get(permission.id) == True %}'grant'{% elif user_perms.get(permission.id) == False %}'deny'{% else %}''{% endif %},
    {% endfor %}
  };
  
  Object.keys(originalState).forEach(permissionId => {
    const value = originalState[permissionId];
    const radio = document.querySelector(`input[name="permission_${permissionId}"][value="${value}"]`);
    if (radio) {
      radio.checked = true;
    }
  });
  updatePermissionStyles();
}

function updatePermissionStyles() {
  // Update visual styling based on selected options
  document.querySelectorAll('.permission-item').forEach(item => {
    const radios = item.querySelectorAll('input[type="radio"]');
    const checkedRadio = Array.from(radios).find(r => r.checked);
    
    // Remove all style classes
    item.classList.remove('permission-override', 'permission-denied', 'permission-inherited', 'bg-gray-50');
    
    if (checkedRadio) {
      if (checkedRadio.value === 'grant') {
        item.classList.add('permission-override');
      } else if (checkedRadio.value === 'deny') {
        item.classList.add('permission-denied');
      } else {
        // Check if role has this permission
        const hasRolePermission = item.querySelector('.text-green-600') !== null;
        if (hasRolePermission) {
          item.classList.add('permission-inherited');
        } else {
          item.classList.add('bg-gray-50');
        }
      }
    }
  });
}

// Add event listeners to all radio buttons
document.addEventListener('DOMContentLoaded', function() {
  const radios = document.querySelectorAll('input[type="radio"]');
  radios.forEach(radio => {
    radio.addEventListener('change', updatePermissionStyles);
  });
});

// Form submission handler
document.getElementById('userPermissionsForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Collect all permission changes
  const formData = new FormData(this);
  const permissions = {};
  let overrideCount = 0;
  
  {% for permission in all_permissions %}
  const perm{{ loop.index }} = formData.get('permission_{{ permission.id }}');
  if (perm{{ loop.index }} && perm{{ loop.index }} !== '') {
    permissions['{{ permission.id }}'] = perm{{ loop.index }};
    overrideCount++;
  }
  {% endfor %}
  
  // Create hidden inputs for the actual form submission
  Object.keys(permissions).forEach(permId => {
    if (permissions[permId] === 'grant') {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'granted_permissions';
      input.value = permId;
      this.appendChild(input);
    } else if (permissions[permId] === 'deny') {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'denied_permissions';
      input.value = permId;
      this.appendChild(input);
    }
  });
  
  Swal.fire({
    title: 'Update User Permissions?',
    text: `This will set ${overrideCount} permission overrides for {{ user.full_name }}.`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#2563eb',
    cancelButtonColor: '#6b7280',
    confirmButtonText: 'Yes, update permissions',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      this.submit();
    } else {
      // Remove hidden inputs if cancelled
      const hiddenInputs = this.querySelectorAll('input[type="hidden"][name*="_permissions"]');
      hiddenInputs.forEach(input => input.remove());
    }
  });
});
</script>

{% endblock %}
