<!-- templates/permissions/role_permissions_management.html -->
{% extends 'layout/layout.html' %}
{% block content %}

<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.min.css" rel="stylesheet">

<style>
  .permission-group {
    transition: all 0.3s ease;
  }
  .permission-item:hover {
    background-color: #f9fafb;
  }
</style>

<!-- Role Permission Management -->
<div class="container-fluid px-4 py-6">
  
  <!-- Header Section -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Role Permissions</h1>
        <p class="text-gray-600 mt-1">Manage permissions by user role</p>
      </div>
      <div>
        <a href="{{ url_for('permissions_management.list_permissions') }}" 
           class="btn bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Permissions
        </a>
      </div>
    </div>
  </div>

  <!-- Role Selection -->
  <div class="bg-white rounded-lg shadow-md border p-6 mb-6">
    <div class="flex items-center gap-4">
      <label class="text-sm font-medium text-gray-700">Select Role:</label>
      <select id="roleSelect" onchange="loadRolePermissions()" 
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        <option value="">Choose a role...</option>
        {% for role_type in roles %}
        <option value="{{ role_type.value }}" {% if role and role.value == role_type.value %}selected{% endif %}>
          {{ role_type.value.replace('_', ' ').title() }}
        </option>
        {% endfor %}
      </select>
    </div>
  </div>

  {% if role %}
  <!-- Role Permissions Form -->
  <form method="POST" action="{{ url_for('permissions_management.update_role_permissions') }}" id="rolePermissionsForm">
    <input type="hidden" name="role" value="{{ role.value }}">
    
    <div class="bg-white rounded-lg shadow-md border">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-800">
            Permissions for {{ role.value.replace('_', ' ').title() }}
          </h3>
          <div class="flex gap-2">
            <button type="button" onclick="selectAll(true)" 
                    class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
              Select All
            </button>
            <button type="button" onclick="selectAll(false)" 
                    class="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
              Deselect All
            </button>
          </div>
        </div>
      </div>
      
      <div class="p-6">
        {% set current_category = None %}
        {% for permission in all_permissions %}
          {% if permission.category != current_category %}
            {% if current_category is not none %}
              </div>
            {% endif %}
            {% set current_category = permission.category %}
            <div class="permission-group mb-6">
              <h4 class="text-md font-semibold text-gray-700 mb-3 pb-2 border-b">
                {{ current_category or 'Uncategorized' }}
              </h4>
              <div class="space-y-2">
          {% endif %}
          
          <label class="permission-item flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="checkbox" name="permissions" value="{{ permission.id }}"
                   {% if role_perms.get(permission.id) %}checked{% endif %}
                   class="rounded border-gray-300 text-primary-600 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50">
            <div class="ml-3 flex-1">
              <div class="font-medium text-gray-900">{{ permission.name }}</div>
              {% if permission.description %}
              <div class="text-sm text-gray-600">{{ permission.description }}</div>
              {% endif %}
            </div>
            {% if permission.is_system %}
            <span class="inline-flex px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">
              System
            </span>
            {% endif %}
          </label>
          
        {% endfor %}
        {% if current_category is not none %}
          </div>
        {% endif %}
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="px-6 py-4 bg-gray-50 border-t flex justify-end space-x-4">
        <button type="button" onclick="resetForm()" 
                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
          Reset
        </button>
        <button type="submit" 
                class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Update Permissions
        </button>
      </div>
    </div>
  </form>
  {% else %}
  <!-- No Role Selected -->
  <div class="bg-white rounded-lg shadow-md border p-12 text-center">
    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
    </svg>
    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Role</h3>
    <p class="text-gray-500">Choose a role from the dropdown above to manage its permissions.</p>
  </div>
  {% endif %}

</div>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.all.min.js"></script>

<script>
// SweetAlert Toast Configuration
const Toast = Swal.mixin({
  toast: true,
  position: 'top-end',
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener('mouseenter', Swal.stopTimer)
    toast.addEventListener('mouseleave', Swal.resumeTimer)
  }
})

// Show flash messages
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    document.addEventListener('DOMContentLoaded', function() {
      {% for category, message in messages %}
        Toast.fire({
          icon: '{{ "success" if category == "success" else "error" }}',
          title: '{{ message }}'
        });
      {% endfor %}
    });
  {% endif %}
{% endwith %}

function loadRolePermissions() {
  const select = document.getElementById('roleSelect');
  if (select.value) {
    window.location.href = `{{ url_for('permissions_management.role_permissions') }}?role=${select.value}`;
  } else {
    window.location.href = `{{ url_for('permissions_management.role_permissions') }}`;
  }
}

function selectAll(checked) {
  const checkboxes = document.querySelectorAll('input[name="permissions"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = checked;
  });
}

function resetForm() {
  // Reset to original state
  {% if role %}
  const originalState = {{ role_perms | tojson }};
  const checkboxes = document.querySelectorAll('input[name="permissions"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = originalState[checkbox.value] || false;
  });
  {% endif %}
}

// Form submission confirmation
document.getElementById('rolePermissionsForm')?.addEventListener('submit', function(e) {
  e.preventDefault();
  
  const checkedPermissions = document.querySelectorAll('input[name="permissions"]:checked').length;
  const totalPermissions = document.querySelectorAll('input[name="permissions"]').length;
  
  Swal.fire({
    title: 'Update Role Permissions?',
    text: `This will set ${checkedPermissions} out of ${totalPermissions} permissions for this role.`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#2563eb',
    cancelButtonColor: '#6b7280',
    confirmButtonText: 'Yes, update permissions',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      this.submit();
    }
  });
});
</script>

{% endblock %}
