{% extends 'layout/layout.html' %} {% block content %}

<style>
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
</style>

<!-- Bank Management Header & Stats -->
<div class="flex flex-wrap items-center justify-between mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Accounts</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalAccounts">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Active Accounts</p>
                <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="activeAccounts">0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Balance</p>
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="totalBalance">â‚¹0.00</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Today's Transactions</p>
                <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="todayTransactions">0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                </svg>
            </div>
        </div>
    </div>
</div>

<!-- Filters & Search -->
<div class="card border-0 mb-6">
    <div class="card-header flex flex-wrap items-end gap-4 p-4 overflow-x-auto hide-scrollbar">
        <div class="flex-shrink-0">
            <label for="dateFrom" class="form-label">From Date</label>
            <input type="date" id="dateFrom" name="dateFrom" class="form-control" />
        </div>

        <div class="flex-shrink-0">
            <label for="dateTo" class="form-label">To Date</label>
            <input type="date" id="dateTo" name="dateTo" class="form-control" />
        </div>

        <div class="flex-shrink-0">
            <label class="form-label">Account Status</label>
            <div>
                <button data-dropdown-toggle="statusDropdown" data-dropdown-placement="bottom"
                    class="text-primary-600 focus:bg-primary-600 hover:bg-primary-700 border border-primary-600 hover:text-white focus:text-white focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-base px-3 py-2 text-center inline-flex items-center dark:text-primary-400 dark:hover:text-white dark:focus:text-white dark:focus:ring-primary-800"
                    type="button">
                    <span id="statusFilterText">All Status</span>
                    <svg class="w-2.5 h-2.5 ms-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
                    </svg>
                </button>
                <div id="statusDropdown" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-2xl w-44 dark:bg-gray-700">
                    <ul class="py-2 text-base text-gray-700 dark:text-gray-200">
                        <li><a href="#" onclick="setStatusFilter('')" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">All Status</a></li>
                        <li><a href="#" onclick="setStatusFilter('ACTIVE')" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Active</a></li>
                        <li><a href="#" onclick="setStatusFilter('INACTIVE')" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Inactive</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0">
            <label class="form-label">Account Type</label>
            <div>
                <button data-dropdown-toggle="typeDropdown" data-dropdown-placement="bottom"
                    class="text-primary-600 focus:bg-primary-600 hover:bg-primary-700 border border-primary-600 hover:text-white focus:text-white focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-base px-3 py-2 text-center inline-flex items-center dark:text-primary-400 dark:hover:text-white dark:focus:text-white dark:focus:ring-primary-800"
                    type="button">
                    <span id="typeFilterText">All Types</span>
                    <svg class="w-2.5 h-2.5 ms-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
                    </svg>
                </button>
                <div id="typeDropdown" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-2xl w-44 dark:bg-gray-700">
                    <ul class="py-2 text-base text-gray-700 dark:text-gray-200">
                        <li><a href="#" onclick="setTypeFilter('')" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">All Types</a></li>
                        <li><a href="#" onclick="setTypeFilter('SAVINGS')" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Savings</a></li>
                        <li><a href="#" onclick="setTypeFilter('CURRENT')" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Current</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0 min-w-80">
            <label for="searchInput" class="form-label">Search</label>
            <input type="text" id="searchInput" placeholder="Search by account name, number, bank..." class="form-control" />
        </div>

        <div class="flex flex-shrink-0 gap-2">
            <button type="button" onclick="searchAccounts()" class="btn bg-primary-600 hover:bg-primary-700 text-white rounded-lg px-5 py-2">
                Search
            </button>
            <button type="button" onclick="resetFilters()" class="btn bg-gray-500 hover:bg-gray-600 text-white rounded-lg px-5 py-2">
                Reset
            </button>
            <!-- Add Account Button - Fixed URL -->
            <a href="{{ url_for('bank_management.add_account_page') }}" class="btn bg-success-600 hover:bg-success-700 text-white rounded-lg px-5 py-2 inline-flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add Account
            </a>
            <button type="button" onclick="exportAccounts('excel')" class="btn bg-green-600 hover:bg-green-700 text-white rounded-lg px-5 py-2">
                Export Excel
            </button>
            <button type="button" onclick="exportAccounts('pdf')" class="btn bg-red-600 hover:bg-red-700 text-white rounded-lg px-5 py-2">
                Export PDF
            </button>
        </div>
    </div>
</div>

<!-- Bank Accounts Table -->
<div class="grid grid-cols-12">
    <div class="col-span-12">
        <div class="card-header flex flex-wrap items-center justify-between gap-3 mb-4">
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <h6 class="text-lg font-semibold">Bank Accounts Management</h6>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">Total: <span id="totalRecords" class="font-semibold">0</span></span>
            </div>
        </div>

        <div class="border border-gray-300 rounded-lg">
            <div class="card-body border border-gray-300 rounded-lg bg-white overflow-hidden">
                <div class="table-responsive overflow-x-auto hide-scrollbar">
                    <table class="table mb-0 bg-white w-full">
                        <thead>
                            <tr>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded form-check style-check flex items-center gap-2 py-3 px-4">
                                        <input type="checkbox" id="selectAll" class="form-check-input" onchange="toggleSelectAll()">
                                        <label class="form-check-label font-semibold">Select</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Account Code</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Account Name</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Account Number</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Bank Name</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">IFSC Code</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Account Type</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Current Balance</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Status</label>
                                    </div>
                                </th>
                                <th scope="col">
                                    <div class="border border-gray-300 bg-white rounded flex items-center gap-2 py-3 px-4">
                                        <label class="font-semibold">Actions</label>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex flex-col sm:flex-row justify-between items-center mt-6 px-4 pb-4">
                    <div class="text-sm text-gray-700 dark:text-gray-400">
                        Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalEntries">0</span> entries
                    </div>
                    <div class="flex items-center space-x-2 mt-4 sm:mt-0">
                        <button onclick="changePage('prev')" id="prevPageBtn" 
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <div id="pageNumbers" class="flex space-x-1">
                            <!-- Page numbers will be generated here -->
                        </div>
                        <button onclick="changePage('next')" id="nextPageBtn"
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActionsBar" class="hidden mt-4 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm font-medium text-blue-700 dark:text-blue-300">
                    <span id="selectedCount">0</span> accounts selected
                </span>
                <div class="flex gap-2">
                    <button onclick="bulkUpdateStatus('ACTIVE')" class="btn bg-green-600 hover:bg-green-700 text-white rounded-lg px-4 py-2 text-sm">
                        Activate Selected
                    </button>
                    <button onclick="bulkUpdateStatus('INACTIVE')" class="btn bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 text-sm">
                        Deactivate Selected
                    </button>
                    <button onclick="bulkToggleVisibility()" class="btn bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg px-4 py-2 text-sm">
                        Toggle Visibility
                    </button>
                    <button onclick="clearSelection()" class="btn bg-gray-500 hover:bg-gray-600 text-white rounded-lg px-4 py-2 text-sm">
                        Clear Selection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
let totalPages = 1;
let selectedAccounts = new Set();
let allAccounts = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadBankStats();
    loadBankAccounts();
});

// Load bank statistics
async function loadBankStats() {
    try {
        const response = await fetch('/bank-management/api/stats');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('totalAccounts').textContent = data.total_accounts;
            document.getElementById('activeAccounts').textContent = data.active_accounts;
            document.getElementById('totalBalance').textContent = `â‚¹${parseFloat(data.total_balance).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
            document.getElementById('todayTransactions').textContent = data.today_transactions;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load bank accounts
async function loadBankAccounts(page = 1) {
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            search: document.getElementById('searchInput').value || '',
            status: getStatusFilter(),
            purpose: getTypeFilter()
        });
        
        const response = await fetch(`/bank-management/api/accounts?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            allAccounts = data.accounts;
            renderAccountsTable(data.accounts);
            updatePagination(data.pagination);
            document.getElementById('totalRecords').textContent = data.pagination.total;
        } else {
            showAlert('Error loading accounts: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error loading accounts:', error);
        showAlert('Error loading accounts', 'error');
    }
}

// Render accounts table
function renderAccountsTable(accounts) {
    const tbody = document.getElementById('accountsTableBody');
    tbody.innerHTML = '';
    
    accounts.forEach((account, index) => {
        const row = createAccountRow(account, index);
        tbody.appendChild(row);
    });
    
    updateBulkActionsBar();
}

// Create account table row - FIXED VERSION
function createAccountRow(account, index) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
    
    const statusBadge = getStatusBadge(account.status);
    
    row.innerHTML = `
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <input type="checkbox" value="${account.id}" class="account-checkbox" onchange="handleAccountSelection('${account.id}')">
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span class="font-medium">${account.account_code}</span>
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span class="font-medium">${account.account_name}</span>
                ${account.is_primary ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full ml-2">Primary</span>' : ''}
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span class="font-mono">${account.account_number}</span>
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span>${account.bank_name}</span>
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span class="font-mono">${account.ifsc_code}</span>
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span class="capitalize">${account.account_type.toLowerCase()}</span>
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <span class="font-semibold text-green-600">â‚¹${parseFloat(account.current_balance).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                ${statusBadge}
            </div>
        </td>
        <td>
            <div class="border border-gray-300 rounded flex items-center gap-2 py-2 px-4">
                <div class="flex flex-wrap gap-1">
                    <a href="/bank-management/account/${account.id}" class="btn bg-blue-500 hover:bg-blue-600 text-black rounded px-3 py-1 text-xs inline-flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        View
                    </a>
                    <a href="/bank-management/update-account/${account.id}" class="btn bg-yellow-500 hover:bg-yellow-600 text-black rounded px-3 py-1 text-xs inline-flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Edit
                    </a>
                    <button onclick="toggleAccountStatus('${account.id}')" class="btn ${account.status === 'ACTIVE' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-black rounded px-3 py-1 text-xs inline-flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${account.status === 'ACTIVE' ? 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}"></path>
                        </svg>
                        ${account.status === 'ACTIVE' ? 'Disable' : 'Enable'}
                    </button>
                </div>
            </div>
        </td>
    `;
    
    return row;
}

// Get status badge HTML
function getStatusBadge(status) {
    const badges = {
        'ACTIVE': '<span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded">Active</span>',
        'INACTIVE': '<span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-0.5 rounded">Inactive</span>',
        'SUSPENDED': '<span class="bg-yellow-100 text-yellow-800 text-sm font-medium px-2.5 py-0.5 rounded">Suspended</span>'
    };
    return badges[status] || '<span class="bg-gray-100 text-gray-800 text-sm font-medium px-2.5 py-0.5 rounded">Unknown</span>';
}

// Filter functions
function setStatusFilter(status) {
    document.getElementById('statusFilterText').textContent = status ? status.charAt(0) + status.slice(1).toLowerCase() : 'All Status';
    document.querySelector('[data-dropdown-toggle="statusDropdown"]').setAttribute('data-status', status);
}

function setTypeFilter(type) {
    document.getElementById('typeFilterText').textContent = type ? type.charAt(0) + type.slice(1).toLowerCase() : 'All Types';
    document.querySelector('[data-dropdown-toggle="typeDropdown"]').setAttribute('data-type', type);
}

function getStatusFilter() {
    return document.querySelector('[data-dropdown-toggle="statusDropdown"]').getAttribute('data-status') || '';
}

function getTypeFilter() {
    return document.querySelector('[data-dropdown-toggle="typeDropdown"]').getAttribute('data-type') || '';
}

// Search and filter functions
function searchAccounts() {
    currentPage = 1;
    loadBankAccounts(currentPage);
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    setStatusFilter('');
    setTypeFilter('');
    currentPage = 1;
    loadBankAccounts(currentPage);
}

// Selection functions
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.account-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedAccounts.add(checkbox.value);
        } else {
            selectedAccounts.delete(checkbox.value);
        }
    });
    
    updateBulkActionsBar();
}

function handleAccountSelection(accountId) {
    const checkbox = document.querySelector(`input[value="${accountId}"]`);
    if (checkbox.checked) {
        selectedAccounts.add(accountId);
    } else {
        selectedAccounts.delete(accountId);
    }
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.account-checkbox');
    const checkedBoxes = document.querySelectorAll('.account-checkbox:checked');
    const selectAll = document.getElementById('selectAll');
    
    selectAll.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
    selectAll.checked = checkedBoxes.length === allCheckboxes.length;
    
    updateBulkActionsBar();
}

function updateBulkActionsBar() {
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedAccounts.size > 0) {
        bulkBar.classList.remove('hidden');
        selectedCount.textContent = selectedAccounts.size;
    } else {
        bulkBar.classList.add('hidden');
    }
}

function clearSelection() {
    selectedAccounts.clear();
    document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateBulkActionsBar();
}

// Status toggle function
async function toggleAccountStatus(accountId) {
    if (!confirm('Are you sure you want to toggle the account status?')) return;
    
    try {
        const response = await fetch(`/bank-management/api/accounts/${accountId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(data.message, 'success');
            loadBankAccounts(currentPage);
            loadBankStats();
        } else {
            showAlert('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error toggling status:', error);
        showAlert('Error toggling account status', 'error');
    }
}

// Bulk operations
async function bulkUpdateStatus(status) {
    if (selectedAccounts.size === 0) {
        showAlert('Please select accounts first', 'error');
        return;
    }
    
    if (!confirm(`Are you sure you want to ${status.toLowerCase()} ${selectedAccounts.size} accounts?`)) return;
    
    try {
        const response = await fetch('/bank-management/api/accounts/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_ids: Array.from(selectedAccounts),
                action: status === 'ACTIVE' ? 'activate' : 'deactivate'
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(data.message, 'success');
            clearSelection();
            loadBankAccounts(currentPage);
            loadBankStats();
        } else {
            showAlert('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error bulk updating:', error);
        showAlert('Error updating accounts', 'error');
    }
}

async function bulkToggleVisibility() {
    if (selectedAccounts.size === 0) {
        showAlert('Please select accounts first', 'error');
        return;
    }
    
    if (!confirm(`Are you sure you want to toggle visibility for ${selectedAccounts.size} accounts?`)) return;
    
    try {
        const response = await fetch('/bank-management/api/accounts/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_ids: Array.from(selectedAccounts),
                action: 'toggle_visibility'
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(data.message, 'success');
            clearSelection();
            loadBankAccounts(currentPage);
        } else {
            showAlert('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error bulk updating:', error);
        showAlert('Error updating accounts', 'error');
    }
}

// Pagination functions
function updatePagination(pagination) {
    currentPage = pagination.page;
    totalPages = pagination.pages;
    
    document.getElementById('showingFrom').textContent = ((pagination.page - 1) * pagination.per_page) + 1;
    document.getElementById('showingTo').textContent = Math.min(pagination.page * pagination.per_page, pagination.total);
    document.getElementById('totalEntries').textContent = pagination.total;
    
    // Update pagination buttons
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    prevBtn.disabled = !pagination.has_prev;
    nextBtn.disabled = !pagination.has_next;
    
    if (!pagination.has_prev) {
        prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    if (!pagination.has_next) {
        nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // Generate page numbers
    generatePageNumbers(pagination);
}

function generatePageNumbers(pagination) {
    const pageNumbersContainer = document.getElementById('pageNumbers');
    pageNumbersContainer.innerHTML = '';
    
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = `px-3 py-2 text-sm font-medium border border-gray-300 rounded-lg ${
            i === pagination.page 
                ? 'bg-primary-600 text-white border-primary-600' 
                : 'text-gray-500 bg-white hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'
        }`;
        pageBtn.onclick = () => changePage(i);
        pageNumbersContainer.appendChild(pageBtn);
    }
}

function changePage(page) {
    if (page === 'prev') {
        page = Math.max(1, currentPage - 1);
    } else if (page === 'next') {
        page = Math.min(totalPages, currentPage + 1);
    }
    
    if (page !== currentPage) {
        loadBankAccounts(page);
    }
}

// Export functions
async function exportAccounts(format) {
    try {
        const params = new URLSearchParams({
            format: format,
            search: document.getElementById('searchInput').value || '',
            status: getStatusFilter(),
            purpose: getTypeFilter()
        });
        
        window.open(`/bank-management/api/accounts/export?${params}`);
    } catch (error) {
        console.error('Error exporting:', error);
        showAlert('Error exporting accounts', 'error');
    }
}

// Utility functions
function showAlert(message, type = 'info') {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
        type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
        type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
        'bg-blue-100 text-blue-800 border border-blue-200'
    }`;
    
    alert.innerHTML = `
        <div class="flex items-center">
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(alert);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}
</script>

{% endblock %}
