<!-- templates/bank_management/account_details.html -->
{% extends 'layout/layout.html' %} 
{% block content %}

<style>
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .info-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .info-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }
  .info-value {
    font-size: 1rem;
    color: #111827;
    font-weight: 600;
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 9999px;
  }
  .status-active { background-color: #dcfce7; color: #166534; }
  .status-inactive { background-color: #fef2f2; color: #991b1b; }
  .table-row:hover { background-color: #f9fafb; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .tab-button {
    padding: 0.75rem 1.5rem;
    border-bottom: 2px solid transparent;
    font-weight: 500;
    transition: all 0.2s;
  }
  .tab-button.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
  }
  .form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
  }
</style>

<!-- Account Details -->
<div class="container-fluid px-4 py-6">
  
  <!-- Header Section -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">{{ title if title else 'Bank Account Details' }}</h1>
        <p class="text-gray-600 mt-1">{{ subtitle if subtitle else 'Account information and transaction history' }}</p>
      </div>
      <div class="flex gap-3">
        <button onclick="editAccount()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
          Edit Account
        </button>
        <button id="toggleStatusBtn" onclick="toggleAccountStatus()" class="btn bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg">
          Toggle Status
        </button>
        <a href="{{ url_for('bank_management.bank_accounts_page') }}" 
           class="btn bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
          Back to Accounts
        </a>
      </div>
    </div>
  </div>

  <!-- Account Overview Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6 border">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Current Balance</p>
          <p id="currentBalance" class="text-2xl font-bold text-blue-600">₹0</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-full">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 border">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Daily Limit Available</p>
          <p id="dailyLimit" class="text-2xl font-bold text-green-600">₹0</p>
        </div>
        <div class="bg-green-100 p-3 rounded-full">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 border">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Total Transactions</p>
          <p id="totalTransactions" class="text-2xl font-bold text-purple-600">0</p>
        </div>
        <div class="bg-purple-100 p-3 rounded-full">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 border">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">Account Status</p>
          <p id="accountStatus" class="text-2xl font-bold">-</p>
        </div>
        <div id="statusIcon" class="p-3 rounded-full">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white rounded-lg shadow-md border mb-6">
    <div class="border-b">
      <nav class="flex space-x-8 px-6">
        <button onclick="switchTab('details')" id="detailsTab" class="tab-button active">
          Account Details
        </button>
        <button onclick="switchTab('transactions')" id="transactionsTab" class="tab-button">
          Transactions
        </button>
        <button onclick="switchTab('permissions')" id="permissionsTab" class="tab-button">
          Permissions
        </button>
        <button onclick="switchTab('settings')" id="settingsTab" class="tab-button">
          Settings
        </button>
      </nav>
    </div>

    <!-- Account Details Tab -->
    <div id="detailsContent" class="tab-content active p-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Basic Information -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Basic Information</h3>
          
          <div class="info-card">
            <div class="info-label">Account Name</div>
            <div id="accountName" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Account Holder Name</div>
            <div id="accountHolderName" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Account Number</div>
            <div id="accountNumber" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Account Type</div>
            <div id="accountType" class="info-value">-</div>
          </div>

          <div class="info-card">
            <div class="info-label">Account Code</div>
            <div id="accountCode" class="info-value">-</div>
          </div>
        </div>

        <!-- Bank Information -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Bank Information</h3>
          
          <div class="info-card">
            <div class="info-label">Bank Name</div>
            <div id="bankName" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">IFSC Code</div>
            <div id="ifscCode" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Branch Name</div>
            <div id="branchName" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">UPI ID</div>
            <div id="upiId" class="info-value">-</div>
          </div>

          <div class="info-card">
            <div class="info-label">Branch Address</div>
            <div id="branchAddress" class="info-value">-</div>
          </div>
        </div>

        <!-- Financial Details -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Financial Details</h3>
          
          <div class="info-card">
            <div class="info-label">Current Balance</div>
            <div id="detailCurrentBalance" class="info-value">₹0</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Minimum Balance</div>
            <div id="minimumBalance" class="info-value">₹0</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Daily Limit</div>
            <div id="detailDailyLimit" class="info-value">₹0</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Monthly Limit</div>
            <div id="monthlyLimit" class="info-value">₹0</div>
          </div>

          <div class="info-card">
            <div class="info-label">PAN Number</div>
            <div id="panNumber" class="info-value">-</div>
          </div>

          <div class="info-card">
            <div class="info-label">GSTIN</div>
            <div id="gstin" class="info-value">-</div>
          </div>
        </div>

        <!-- Account Settings -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Account Settings</h3>
          
          <div class="info-card">
            <div class="info-label">Purpose</div>
            <div id="accountPurpose" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Priority</div>
            <div id="accountPriority" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Display Order</div>
            <div id="displayOrder" class="info-value">-</div>
          </div>
          
          <div class="info-card">
            <div class="info-label">Account Flags</div>
            <div id="accountFlags" class="info-value">
              <div id="flagsList" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Transactions Tab -->
    <div id="transactionsContent" class="tab-content p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Transaction History</h3>
        <div class="flex gap-2">
          <button onclick="showAddTransactionModal()" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
            Add Manual Transaction
          </button>
          <button onclick="exportTransactions()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
            Export
          </button>
        </div>
      </div>

      <!-- Transaction Filters -->
      <div class="flex gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
          <select id="transactionTypeFilter" onchange="loadTransactions()" class="form-control">
            <option value="">All Types</option>
            <option value="CREDIT">Credit</option>
            <option value="DEBIT">Debit</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Date From</label>
          <input type="date" id="dateFromFilter" onchange="loadTransactions()" class="form-control">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Date To</label>
          <input type="date" id="dateToFilter" onchange="loadTransactions()" class="form-control">
        </div>
      </div>

      <!-- Transactions Table -->
      <div class="overflow-x-auto">
        <table class="w-full bg-white border border-gray-200 rounded-lg">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date & Time</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Balance Before</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Balance After</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Reference</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                Loading transactions...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Transaction Pagination -->
      <div id="transactionPagination" class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-700">
          Showing <span id="txnShowingStart">0</span> to <span id="txnShowingEnd">0</span> of <span id="txnTotalRecords">0</span> transactions
        </div>
        <div class="flex gap-2" id="txnPaginationButtons">
          <!-- Pagination buttons will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Permissions Tab -->
    <div id="permissionsContent" class="tab-content p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Role-Based Permissions</h3>
      <div id="permissionsList">
        <div class="text-center text-gray-500 py-8">
          Loading permissions...
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsContent" class="tab-content p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Account Settings</h3>
      <div class="space-y-4">
        <p class="text-gray-600">Advanced settings and configuration options will be available here.</p>
      </div>
    </div>

  </div>

</div>

<!-- Add Transaction Modal -->
<div id="addTransactionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
    <div class="p-6 border-b">
      <h3 class="text-lg font-semibold text-gray-800">Add Manual Transaction</h3>
    </div>
    <form id="addTransactionForm" class="p-6">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
          <select id="txnType" name="transaction_type" class="form-control" required>
            <option value="">Select type</option>
            <option value="CREDIT">Credit</option>
            <option value="DEBIT">Debit</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
          <input type="number" id="txnAmount" name="amount" class="form-control" min="0.01" step="0.01" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="txnDescription" name="description" class="form-control" rows="3" required></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Reference Number</label>
          <input type="text" id="txnReference" name="reference_number" class="form-control">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">UTR Number</label>
          <input type="text" id="txnUtr" name="utr_number" class="form-control">
        </div>
      </div>
      
      <div class="flex gap-3 justify-end mt-6">
        <button type="button" onclick="closeAddTransactionModal()" class="btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
          Cancel
        </button>
        <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
          Add Transaction
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let currentAccountId = null;
let currentTransactionPage = 1;

document.addEventListener('DOMContentLoaded', function() {
  // Extract account ID from URL
  const pathParts = window.location.pathname.split('/');
  currentAccountId = pathParts[pathParts.length - 1];
  
  if (currentAccountId) {
    loadAccountDetails();
    loadTransactions();
  }

  // Add transaction form submission
  document.getElementById('addTransactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    submitTransaction();
  });

  // Set default date filters to current month
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  if (document.getElementById('dateFromFilter')) {
    document.getElementById('dateFromFilter').value = firstDay.toISOString().split('T')[0];
  }
  if (document.getElementById('dateToFilter')) {
    document.getElementById('dateToFilter').value = lastDay.toISOString().split('T')[0];
  }
});

function loadAccountDetails() {
  fetch(`/bank-management/api/accounts/${currentAccountId}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        showAlert(data.error, 'error');
        return;
      }
      
      displayAccountDetails(data.account);
    })
    .catch(error => {
      console.error('Error loading account details:', error);
      showAlert('Error loading account details', 'error');
    });
}

function displayAccountDetails(account) {
  // Update header stats
  document.getElementById('currentBalance').textContent = `₹${account.current_balance.toLocaleString()}`;
  document.getElementById('dailyLimit').textContent = `₹${account.statistics?.available_daily_limit?.toLocaleString() || 0}`;
  document.getElementById('totalTransactions').textContent = account.statistics?.total_transactions || 0;
  
  const statusElement = document.getElementById('accountStatus');
  const statusIcon = document.getElementById('statusIcon');
  
  if (account.status === 'ACTIVE') {
    statusElement.textContent = 'ACTIVE';
    statusElement.className = 'text-2xl font-bold text-green-600';
    statusIcon.className = 'bg-green-100 p-3 rounded-full';
    statusIcon.querySelector('svg').className = 'w-6 h-6 text-green-600';
  } else {
    statusElement.textContent = 'INACTIVE';
    statusElement.className = 'text-2xl font-bold text-red-600';
    statusIcon.className = 'bg-red-100 p-3 rounded-full';
    statusIcon.querySelector('svg').className = 'w-6 h-6 text-red-600';
  }

  // Update details tab
  document.getElementById('accountName').textContent = account.account_name || '-';
  document.getElementById('accountHolderName').textContent = account.account_holder_name || '-';
  document.getElementById('accountNumber').textContent = account.account_number || '-';
  document.getElementById('accountType').textContent = account.account_type || '-';
  document.getElementById('accountCode').textContent = account.account_code || '-';
  
  document.getElementById('bankName').textContent = account.bank_name || '-';
  document.getElementById('ifscCode').textContent = account.ifsc_code || '-';
  document.getElementById('branchName').textContent = account.branch_name || '-';
  document.getElementById('upiId').textContent = account.upi_id || '-';
  document.getElementById('branchAddress').textContent = account.branch_address || '-';
  
  document.getElementById('detailCurrentBalance').textContent = `₹${account.current_balance.toLocaleString()}`;
  document.getElementById('minimumBalance').textContent = `₹${account.minimum_balance.toLocaleString()}`;
  document.getElementById('detailDailyLimit').textContent = `₹${account.daily_limit.toLocaleString()}`;
  document.getElementById('monthlyLimit').textContent = `₹${account.monthly_limit.toLocaleString()}`;
  document.getElementById('panNumber').textContent = account.pan_number || '-';
  document.getElementById('gstin').textContent = account.gstin || '-';
  
  document.getElementById('accountPurpose').textContent = account.purpose ? account.purpose.join(', ') : '-';
  document.getElementById('accountPriority').textContent = account.priority || '-';
  document.getElementById('displayOrder').textContent = account.display_order || '-';
  
  // Update flags
  const flagsList = document.getElementById('flagsList');
  const flags = [];
  if (account.is_primary) flags.push('Primary');
  if (account.is_default_topup) flags.push('Default Topup');
  if (account.is_default_settlement) flags.push('Default Settlement');
  if (account.is_default_refund) flags.push('Default Refund');
  if (account.is_visible_to_users) flags.push('Visible to Users');
  if (account.auto_settlement) flags.push('Auto Settlement');
  
  flagsList.innerHTML = flags.map(flag => 
    `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${flag}</span>`
  ).join('');
  
  // Update toggle button
  const toggleBtn = document.getElementById('toggleStatusBtn');
  toggleBtn.textContent = account.status === 'ACTIVE' ? 'Deactivate' : 'Activate';
  toggleBtn.className = `btn ${account.status === 'ACTIVE' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white px-6 py-2 rounded-lg`;
}

function loadTransactions(page = 1) {
  currentTransactionPage = page;
  
  const typeFilter = document.getElementById('transactionTypeFilter')?.value || '';
  const dateFrom = document.getElementById('dateFromFilter')?.value || '';
  const dateTo = document.getElementById('dateToFilter')?.value || '';
  
  const params = new URLSearchParams({
    page: page,
    per_page: 20,
    type: typeFilter,
    date_from: dateFrom,
    date_to: dateTo
  });

  fetch(`/bank-management/api/accounts/${currentAccountId}/transactions?${params}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        showAlert(data.error, 'error');
        return;
      }
      
      displayTransactions(data.transactions || []);
      updateTransactionPagination(data.pagination || {});
    })
    .catch(error => {
      console.error('Error loading transactions:', error);
      document.getElementById('transactionsTableBody').innerHTML = 
        '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Error loading transactions</td></tr>';
    });
}

function displayTransactions(transactions) {
  const tbody = document.getElementById('transactionsTableBody');
  
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No transactions found</td></tr>';
    return;
  }

  tbody.innerHTML = transactions.map(transaction => {
    const date = new Date(transaction.created_at).toLocaleString();
    const typeClass = transaction.transaction_type === 'CREDIT' ? 'text-green-600' : 'text-red-600';
    const amountPrefix = transaction.transaction_type === 'CREDIT' ? '+' : '-';
    
    return `
      <tr class="table-row border-b">
        <td class="px-4 py-3 text-sm text-gray-900">${date}</td>
        <td class="px-4 py-3">
          <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${typeClass === 'text-green-600' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
            ${transaction.transaction_type}
          </span>
        </td>
        <td class="px-4 py-3 text-sm font-medium ${typeClass}">
          ${amountPrefix}₹${transaction.amount.toLocaleString()}
        </td>
        <td class="px-4 py-3 text-sm text-gray-900">₹${transaction.balance_before.toLocaleString()}</td>
        <td class="px-4 py-3 text-sm text-gray-900">₹${transaction.balance_after.toLocaleString()}</td>
        <td class="px-4 py-3 text-sm text-gray-900">${transaction.description || '-'}</td>
        <td class="px-4 py-3 text-sm text-gray-900">${transaction.reference_number || transaction.utr_number || '-'}</td>
      </tr>
    `;
  }).join('');
}

function updateTransactionPagination(pagination) {
  document.getElementById('txnShowingStart').textContent = ((pagination.page - 1) * pagination.per_page) + 1;
  document.getElementById('txnShowingEnd').textContent = Math.min(pagination.page * pagination.per_page, pagination.total);
  document.getElementById('txnTotalRecords').textContent = pagination.total;
  
  const paginationContainer = document.getElementById('txnPaginationButtons');
  let buttons = '';
  
  if (pagination.has_prev) {
    buttons += `<button onclick="loadTransactions(${pagination.page - 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Previous</button>`;
  }
  
  const startPage = Math.max(1, pagination.page - 2);
  const endPage = Math.min(pagination.pages, pagination.page + 2);
  
  for (let i = startPage; i <= endPage; i++) {
    const isActive = i === pagination.page;
    buttons += `<button onclick="loadTransactions(${i})" class="px-3 py-2 text-sm font-medium ${isActive ? 'text-primary-600 bg-primary-50 border-primary-500' : 'text-gray-500 bg-white border-gray-300 hover:bg-gray-100'} border rounded-lg">${i}</button>`;
  }
  
  if (pagination.has_next) {
    buttons += `<button onclick="loadTransactions(${pagination.page + 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Next</button>`;
  }
  
  paginationContainer.innerHTML = buttons;
}

function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Show selected tab content
  document.getElementById(tabName + 'Content').classList.add('active');
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  // Load data based on tab
  if (tabName === 'transactions' && currentAccountId) {
    loadTransactions();
  } else if (tabName === 'permissions' && currentAccountId) {
    loadPermissions();
  }
}

function loadPermissions() {
  fetch(`/bank-management/api/role-permissions?bank_account_id=${currentAccountId}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        showAlert(data.error, 'error');
        return;
      }
      
      displayPermissions(data.permissions || []);
    })
    .catch(error => {
      console.error('Error loading permissions:', error);
      document.getElementById('permissionsList').innerHTML = 
        '<div class="text-center text-red-500 py-8">Error loading permissions</div>';
    });
}

function displayPermissions(permissions) {
  const container = document.getElementById('permissionsList');
  
  if (permissions.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 py-8">No role permissions configured</div>';
    return;
  }

  container.innerHTML = `
    <div class="overflow-x-auto">
      <table class="w-full bg-white border border-gray-200 rounded-lg">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Can View</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Can Select</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Can Modify</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">View Balance</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount Limit</th>
          </tr>
        </thead>
        <tbody>
          ${permissions.map(permission => `
            <tr class="border-b">
              <td class="px-4 py-3 text-sm font-medium text-gray-900">${permission.role}</td>
              <td class="px-4 py-3 text-sm">${permission.can_view ? '✅' : '❌'}</td>
              <td class="px-4 py-3 text-sm">${permission.can_select_for_topup ? '✅' : '❌'}</td>
              <td class="px-4 py-3 text-sm">${permission.can_modify ? '✅' : '❌'}</td>
              <td class="px-4 py-3 text-sm">${permission.can_view_balance ? '✅' : '❌'}</td>
              <td class="px-4 py-3 text-sm">₹${permission.amount_limit?.toLocaleString() || 'No limit'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function editAccount() {
  // Create edit URL by replacing the current account path
  const editUrl = `/bank-management/edit-account/${currentAccountId}`;
  window.location.href = editUrl;
}

function toggleAccountStatus() {
  fetch(`/bank-management/api/accounts/${currentAccountId}/toggle-status`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      showAlert(data.error, 'error');
    } else {
      showAlert(data.message, 'success');
      loadAccountDetails(); // Reload to update status
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showAlert('An error occurred while updating account status', 'error');
  });
}

function showAddTransactionModal() {
  document.getElementById('addTransactionModal').classList.remove('hidden');
}

function closeAddTransactionModal() {
  document.getElementById('addTransactionModal').classList.add('hidden');
  document.getElementById('addTransactionForm').reset();
}

function submitTransaction() {
  const form = document.getElementById('addTransactionForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  
  // Convert amount to number
  data.amount = parseFloat(data.amount);
  
  fetch(`/bank-management/api/accounts/${currentAccountId}/transactions`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.error) {
      showAlert(result.error, 'error');
    } else {
      showAlert(result.message, 'success');
      closeAddTransactionModal();
      loadTransactions(); // Reload transactions
      loadAccountDetails(); // Reload to update balance
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showAlert('An error occurred while adding transaction', 'error');
  });
}

function exportTransactions() {
  const typeFilter = document.getElementById('transactionTypeFilter')?.value || '';
  const dateFrom = document.getElementById('dateFromFilter')?.value || '';
  const dateTo = document.getElementById('dateToFilter')?.value || '';
  
  const params = new URLSearchParams({
    type: typeFilter,
    date_from: dateFrom,
    date_to: dateTo
  });
  
  window.open(`/bank-management/api/accounts/${currentAccountId}/transactions/export?${params}`, '_blank');
}

function showAlert(message, type) {
  const alert = document.createElement('div');
  alert.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
    type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
    type === 'info' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
    'bg-red-100 text-red-800 border border-red-200'
  }`;
  alert.textContent = message;
  
  document.body.appendChild(alert);
  
  setTimeout(() => {
    alert.remove();
  }, 5000);
}
</script>

{% endblock %}