{% extends 'layout/layout.html' %}

{% block content %}
<style>
  .profile-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 20px;
    text-align: center;
  }
  
  .dark .stat-card {
    background: #374151;
    border-color: #4b5563;
  }
  
  .role-badge {
    padding: 6px 16px;
    border-radius: 25px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    background: rgba(255, 255, 255, 0.2);
  }
  
  .wallet-card {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-radius: 16px;
    padding: 24px;
  }
</style>

<!-- User Profile Page -->
<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-neutral-800 dark:text-white">User Profile</h1>
      <p class="text-neutral-600 dark:text-neutral-300">View and manage user details</p>
    </div>
    <div class="flex gap-3">
      <a href="{{ url_for('user_management.user_list_page') }}" 
         class="btn bg-neutral-500 hover:bg-neutral-600 text-white rounded-lg px-4 py-2 flex items-center gap-2">
        <iconify-icon icon="material-symbols:arrow-back" class="text-lg"></iconify-icon>
        Back to List
      </a>
      <button onclick="editUser()" 
              class="btn bg-primary-600 hover:bg-primary-700 text-white rounded-lg px-4 py-2 flex items-center gap-2">
        <iconify-icon icon="material-symbols:edit" class="text-lg"></iconify-icon>
        Edit User
      </button>
    </div>
  </div>

  <!-- User Profile Card -->
  <div class="profile-card" id="profileCard">
    <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
      <div class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-3xl font-bold">
        {{ user.full_name[0] if user.full_name else 'U' }}
      </div>
      <div class="flex-1">
        <h2 class="text-2xl font-bold mb-2">{{ user.full_name }}</h2>
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <span class="role-badge">{{ user.role.value.replace('_', ' ').title() }}</span>
          <span class="text-sm opacity-90">{{ user.user_code }}</span>
          <span class="px-3 py-1 rounded-full text-xs font-medium {{ 'bg-green-500' if user.is_active else 'bg-red-500' }}">
            {{ 'Active' if user.is_active else 'Inactive' }}
          </span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div>
            <p class="opacity-75">Email</p>
            <p class="font-medium">{{ user.email }}</p>
          </div>
          <div>
            <p class="opacity-75">Phone</p>
            <p class="font-medium">{{ user.phone }}</p>
          </div>
          <div>
            <p class="opacity-75">Joined</p>
            <p class="font-medium">{{ user.created_at.strftime('%B %d, %Y') }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="statsContainer">
    <div class="stat-card">
      <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900 rounded-lg flex items-center justify-center mx-auto mb-3">
        <iconify-icon icon="material-symbols:group" class="text-primary-600 text-2xl"></iconify-icon>
      </div>
      <h3 class="text-2xl font-bold text-neutral-800 dark:text-white" id="childrenCount">0</h3>
      <p class="text-sm text-neutral-600 dark:text-neutral-400">Sub Users</p>
    </div>
    
    <div class="stat-card">
      <div class="w-12 h-12 bg-success-100 dark:bg-success-900 rounded-lg flex items-center justify-center mx-auto mb-3">
        <iconify-icon icon="material-symbols:account-balance-wallet" class="text-success-600 text-2xl"></iconify-icon>
      </div>
      <h3 class="text-2xl font-bold text-neutral-800 dark:text-white" id="walletBalance">â‚¹0</h3>
      <p class="text-sm text-neutral-600 dark:text-neutral-400">Wallet Balance</p>
    </div>
    
    <div class="stat-card">
      <div class="w-12 h-12 bg-warning-100 dark:bg-warning-900 rounded-lg flex items-center justify-center mx-auto mb-3">
        <iconify-icon icon="material-symbols:receipt-long" class="text-warning-600 text-2xl"></iconify-icon>
      </div>
      <h3 class="text-2xl font-bold text-neutral-800 dark:text-white" id="transactionCount">0</h3>
      <p class="text-sm text-neutral-600 dark:text-neutral-400">Transactions</p>
    </div>
    
    <div class="stat-card">
      <div class="w-12 h-12 bg-info-100 dark:bg-info-900 rounded-lg flex items-center justify-center mx-auto mb-3">
        <iconify-icon icon="material-symbols:verified-user" class="text-info-600 text-2xl"></iconify-icon>
      </div>
      <h3 class="text-lg font-bold text-neutral-800 dark:text-white" id="kycStatus">{{ user.kyc_status.value.replace('_', ' ').title() }}</h3>
      <p class="text-sm text-neutral-600 dark:text-neutral-400">KYC Status</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- User Details -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Basic Information -->
      <div class="card border border-neutral-200 dark:border-neutral-600 rounded-lg">
        <div class="card-header p-6 border-b border-neutral-200 dark:border-neutral-600">
          <h6 class="card-title text-lg font-semibold flex items-center gap-2">
            <iconify-icon icon="material-symbols:person" class="text-primary-600"></iconify-icon>
            Basic Information
          </h6>
        </div>
        <div class="card-body p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Full Name</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.full_name }}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Username</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.username }}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Email</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.email }}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Phone</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.phone }}</p>
            </div>
            {% if user.business_name %}
            <div class="md:col-span-2">
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Business Name</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.business_name }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Address Information -->
      {% if user.address %}
      <div class="card border border-neutral-200 dark:border-neutral-600 rounded-lg">
        <div class="card-header p-6 border-b border-neutral-200 dark:border-neutral-600">
          <h6 class="card-title text-lg font-semibold flex items-center gap-2">
            <iconify-icon icon="material-symbols:location-on" class="text-primary-600"></iconify-icon>
            Address Information
          </h6>
        </div>
        <div class="card-body p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if user.address.line1 %}
            <div class="md:col-span-2">
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Address</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.address.line1 }}</p>
            </div>
            {% endif %}
            {% if user.address.city %}
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">City</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.address.city }}</p>
            </div>
            {% endif %}
            {% if user.address.state %}
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">State</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.address.state }}</p>
            </div>
            {% endif %}
            {% if user.address.pincode %}
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">PIN Code</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.address.pincode }}</p>
            </div>
            {% endif %}
            {% if user.address.country %}
            <div>
              <label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Country</label>
              <p class="mt-1 text-neutral-800 dark:text-white">{{ user.address.country }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Sub Users -->
      <div class="card border border-neutral-200 dark:border-neutral-600 rounded-lg">
        <div class="card-header p-6 border-b border-neutral-200 dark:border-neutral-600">
          <div class="flex justify-between items-center">
            <h6 class="card-title text-lg font-semibold flex items-center gap-2">
              <iconify-icon icon="material-symbols:account-tree" class="text-primary-600"></iconify-icon>
              Sub Users
            </h6>
            <button onclick="loadSubUsers()" class="text-primary-600 hover:text-primary-700 text-sm">
              Refresh
            </button>
          </div>
        </div>
        <div class="card-body p-6">
          <div id="subUsersContainer">
            <!-- Sub users will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Wallet Information -->
      <div class="wallet-card">
        <div class="flex items-center justify-between mb-4">
          <h6 class="text-lg font-semibold">Wallet Details</h6>
          <iconify-icon icon="material-symbols:account-balance-wallet" class="text-2xl"></iconify-icon>
        </div>
        <div id="walletDetails">
          <!-- Wallet details will be loaded here -->
        </div>
        <div class="flex gap-2 mt-4">
          <button onclick="creditWallet()" class="btn bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg px-4 py-2 flex-1 text-sm">
            Credit
          </button>
          <button onclick="debitWallet()" class="btn bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg px-4 py-2 flex-1 text-sm">
            Debit
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card border border-neutral-200 dark:border-neutral-600 rounded-lg">
        <div class="card-header p-6 border-b border-neutral-200 dark:border-neutral-600">
          <h6 class="card-title text-lg font-semibold">Quick Actions</h6>
        </div>
        <div class="card-body p-6 space-y-3">
          <button onclick="toggleUserStatus()" id="statusToggleBtn"
                  class="btn {{ 'bg-danger-600 hover:bg-danger-700' if user.is_active else 'bg-success-600 hover:bg-success-700' }} text-white rounded-lg px-4 py-3 w-full flex items-center justify-center gap-2">
            <iconify-icon icon="material-symbols:{{ 'block' if user.is_active else 'check-circle' }}" class="text-lg"></iconify-icon>
            {{ 'Deactivate User' if user.is_active else 'Activate User' }}
          </button>
          
          <button onclick="resetPassword()"
                  class="btn bg-warning-600 hover:bg-warning-700 text-white rounded-lg px-4 py-3 w-full flex items-center justify-center gap-2">
            <iconify-icon icon="material-symbols:key" class="text-lg"></iconify-icon>
            Reset Password
          </button>
          
          <button onclick="viewTransactions()"
                  class="btn bg-info-600 hover:bg-info-700 text-white rounded-lg px-4 py-3 w-full flex items-center justify-center gap-2">
            <iconify-icon icon="material-symbols:receipt-long" class="text-lg"></iconify-icon>
            View Transactions
          </button>
        </div>
      </div>

      <!-- Hierarchy -->
      {% if user.parent %}
      <div class="card border border-neutral-200 dark:border-neutral-600 rounded-lg">
        <div class="card-header p-6 border-b border-neutral-200 dark:border-neutral-600">
          <h6 class="card-title text-lg font-semibold">Hierarchy</h6>
        </div>
        <div class="card-body p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
              <span class="text-sm font-medium text-primary-600">{{ user.parent.full_name[0] }}</span>
            </div>
            <div>
              <p class="font-medium text-neutral-800 dark:text-white">{{ user.parent.full_name }}</p>
              <p class="text-xs text-neutral-500">{{ user.parent.user_code }} â€¢ Parent</p>
            </div>
          </div>
          <div class="text-sm text-neutral-600 dark:text-neutral-400">
            <p><strong>Level:</strong> {{ user.level }}</p>
            <p><strong>Tree Path:</strong> {{ user.tree_path }}</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Credit Wallet Modal -->
<div id="creditWalletModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white dark:bg-neutral-800 rounded-lg p-6 w-full max-w-md mx-4">
    <h5 class="text-lg font-semibold mb-4">Credit Wallet</h5>
    <form id="creditWalletForm">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Amount (â‚¹)</label>
        <input type="number" name="amount" step="0.01" min="1" required
               class="form-input w-full rounded-lg border-neutral-300 dark:border-neutral-600 dark:bg-neutral-700 py-2 px-3">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Description</label>
        <textarea name="description" rows="2"
                  class="form-textarea w-full rounded-lg border-neutral-300 dark:border-neutral-600 dark:bg-neutral-700 py-2 px-3"
                  placeholder="Enter description..."></textarea>
      </div>
      <div class="flex gap-3">
        <button type="button" onclick="closeCreditModal()" class="btn bg-neutral-500 hover:bg-neutral-600 text-white rounded-lg px-4 py-2 flex-1">
          Cancel
        </button>
        <button type="submit" class="btn bg-success-600 hover:bg-success-700 text-white rounded-lg px-4 py-2 flex-1">
          Credit
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Debit Wallet Modal -->
<div id="debitWalletModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white dark:bg-neutral-800 rounded-lg p-6 w-full max-w-md mx-4">
    <h5 class="text-lg font-semibold mb-4">Debit Wallet</h5>
    <form id="debitWalletForm">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Amount (â‚¹)</label>
        <input type="number" name="amount" step="0.01" min="1" required
               class="form-input w-full rounded-lg border-neutral-300 dark:border-neutral-600 dark:bg-neutral-700 py-2 px-3">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Description</label>
        <textarea name="description" rows="2"
                  class="form-textarea w-full rounded-lg border-neutral-300 dark:border-neutral-600 dark:bg-neutral-700 py-2 px-3"
                  placeholder="Enter description..."></textarea>
      </div>
      <div class="flex gap-3">
        <button type="button" onclick="closeDebitModal()" class="btn bg-neutral-500 hover:bg-neutral-600 text-white rounded-lg px-4 py-2 flex-1">
          Cancel
        </button>
        <button type="submit" class="btn bg-danger-600 hover:bg-danger-700 text-white rounded-lg px-4 py-2 flex-1">
          Debit
        </button>
      </div>
    </form>
  </div>
</div>

<script>
const userId = '{{ user.id }}';
const userActive = {{ user.is_active|tojson }};

document.addEventListener('DOMContentLoaded', function() {
  loadUserDetails();
  loadSubUsers();
  
  // Form handlers
  document.getElementById('creditWalletForm').addEventListener('submit', handleCreditWallet);
  document.getElementById('debitWalletForm').addEventListener('submit', handleDebitWallet);
});

function loadUserDetails() {
  fetch(`/user-management/api/users/${userId}`)
    .then(response => response.json())
    .then(data => {
      if (data.user) {
        updateUserStats(data.user);
        updateWalletDetails(data.user.wallet);
      }
    })
    .catch(error => console.error('Error loading user details:', error));
}

function updateUserStats(user) {
  document.getElementById('childrenCount').textContent = user.children?.length || 0;
  document.getElementById('walletBalance').textContent = `â‚¹${parseFloat(user.wallet?.balance || 0).toLocaleString()}`;
  // Transaction count would come from another API call
}

function updateWalletDetails(wallet) {
  const container = document.getElementById('walletDetails');
  if (wallet) {
    container.innerHTML = `
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="opacity-90">Balance:</span>
          <span class="font-bold">â‚¹${parseFloat(wallet.balance).toLocaleString()}</span>
        </div>
        <div class="flex justify-between">
          <span class="opacity-90">Available:</span>
          <span>â‚¹${parseFloat(wallet.available_balance).toLocaleString()}</span>
        </div>
        <div class="flex justify-between">
          <span class="opacity-90">Hold:</span>
          <span>â‚¹${parseFloat(wallet.hold_balance).toLocaleString()}</span>
        </div>
        <hr class="border-white border-opacity-30">
        <div class="flex justify-between">
          <span class="opacity-90">Daily Limit:</span>
          <span>â‚¹${parseFloat(wallet.daily_limit).toLocaleString()}</span>
        </div>
        <div class="flex justify-between">
          <span class="opacity-90">Monthly Limit:</span>
          <span>â‚¹${parseFloat(wallet.monthly_limit).toLocaleString()}</span>
        </div>
      </div>
    `;
  } else {
    container.innerHTML = '<p class="text-center opacity-75">No wallet found</p>';
  }
}

function loadSubUsers() {
  fetch(`/user-management/api/users/${userId}/children`)
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('subUsersContainer');
      if (data.children && data.children.length > 0) {
        let html = '<div class="space-y-3">';
        data.children.forEach(child => {
          html += `
            <div class="flex items-center gap-3 p-3 bg-neutral-50 dark:bg-neutral-800 rounded-lg">
              <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                <span class="text-sm font-medium text-primary-600">${child.full_name.charAt(0)}</span>
              </div>
              <div class="flex-1">
                <p class="font-medium text-neutral-800 dark:text-white">${child.full_name}</p>
                <p class="text-xs text-neutral-500">${child.user_code} â€¢ ${child.role.replace('_', ' ')}</p>
              </div>
              <div class="text-right">
                <p class="text-sm font-medium">â‚¹${parseFloat(child.wallet_balance || 0).toLocaleString()}</p>
                <p class="text-xs text-neutral-500">Wallet</p>
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="text-center text-neutral-500">No sub users found</p>';
      }
    })
    .catch(error => {
      console.error('Error loading sub users:', error);
      document.getElementById('subUsersContainer').innerHTML = 
        '<p class="text-center text-red-500">Error loading sub users</p>';
    });
}

function editUser() {
  // Implement edit user functionality
  alert('Edit user functionality - implementation needed');
}

function toggleUserStatus() {
  const action = userActive ? 'deactivate' : 'activate';
  const confirmMsg = `Are you sure you want to ${action} this user?`;
  
  if (confirm(confirmMsg)) {
    fetch(`/user-management/api/users/${userId}/toggle-status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
      } else {
        alert(data.message);
        location.reload(); // Reload page to reflect changes
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating user status');
    });
  }
}

function resetPassword() {
  const newPassword = prompt('Enter new password (minimum 6 characters):');
  if (newPassword && newPassword.length >= 6) {
    fetch(`/user-management/api/users/${userId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
      } else {
        alert('Password reset successfully!');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error resetting password');
    });
  }
}

function viewTransactions() {
  // Implement view transactions functionality
  alert('View transactions functionality - implementation needed');
}

// Wallet Management
function creditWallet() {
  document.getElementById('creditWalletModal').classList.remove('hidden');
}

function debitWallet() {
  document.getElementById('debitWalletModal').classList.remove('hidden');
}

function closeCreditModal() {
  document.getElementById('creditWalletModal').classList.add('hidden');
  document.getElementById('creditWalletForm').reset();
}

function closeDebitModal() {
  document.getElementById('debitWalletModal').classList.add('hidden');
  document.getElementById('debitWalletForm').reset();
}

function handleCreditWallet(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    amount: parseFloat(formData.get('amount')),
    description: formData.get('description') || 'Admin credit'
  };

  fetch(`/user-management/api/users/${userId}/wallet/credit`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert('Error: ' + data.error);
    } else {
      alert(data.message);
      closeCreditModal();
      loadUserDetails(); // Reload user details
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error crediting wallet');
  });
}

function handleDebitWallet(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    amount: parseFloat(formData.get('amount')),
    description: formData.get('description') || 'Admin debit'
  };

  fetch(`/user-management/api/users/${userId}/wallet/debit`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert('Error: ' + data.error);
    } else {
      alert(data.message);
      closeDebitModal();
      loadUserDetails(); // Reload user details
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error debiting wallet');
  });
}
</script>
{% endblock %}
