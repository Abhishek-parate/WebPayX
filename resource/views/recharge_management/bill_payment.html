{% extends 'layout/layout.html' %}

{% block title %}Bill Payment{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
    <!-- Wallet Balance Card -->
    <div class="bg-gradient-to-r from-yellow-500 via-yellow-600 to-orange-600 rounded-2xl shadow-xl p-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg opacity-90 mb-2">üí≥ Available Balance</h3>
                <p class="text-4xl font-bold">‚Çπ{{ "{:,.2f}".format(wallet_balance) }}</p>
                <button onclick="addMoney()" class="mt-4 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all duration-200 backdrop-blur-sm">
                    <i class="fas fa-plus mr-2"></i>Add Money
                </button>
            </div>
            <div class="bg-white/20 p-6 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-file-invoice-dollar text-4xl"></i>
            </div>
        </div>
    </div>

    <!-- Bill Payment Form -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 overflow-hidden">
        <!-- Form Header -->
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-8 border-b border-yellow-100">
            <div class="flex items-center">
                <div class="bg-yellow-500 p-4 rounded-2xl mr-6 shadow-lg">
                    <i class="fas fa-file-invoice-dollar text-white text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Bill Payment</h2>
                    <p class="text-gray-600 mt-1">Quick and secure bill payments for electricity, gas, water & more</p>
                </div>
            </div>
        </div>

        <!-- Form Body -->
        <div class="p-8">
            <form method="POST" onsubmit="return validateBillForm(event)" class="space-y-8">
                <!-- Bill Type Selection -->
                <div class="space-y-4">
                    <label class="flex items-center text-lg font-semibold text-gray-800">
                        <i class="fas fa-list-alt mr-3 text-indigo-600"></i>Select Bill Type
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl hover:border-yellow-300 hover:bg-yellow-50 cursor-pointer transition-all duration-200 group">
                            <input type="radio" name="bill_type" value="electricity" class="sr-only" onchange="selectBillType(this)">
                            <div class="flex items-center space-x-4 w-full">
                                <div class="w-12 h-12 bg-yellow-100 group-hover:bg-yellow-200 rounded-xl flex items-center justify-center transition-colors duration-200">
                                    <i class="fas fa-bolt text-yellow-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Electricity Bill</p>
                                    <p class="text-sm text-gray-500">Pay your electricity bill instantly</p>
                                </div>
                            </div>
                            <div class="ml-auto">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full hidden"></div>
                                </div>
                            </div>
                        </label>

                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl hover:border-red-300 hover:bg-red-50 cursor-pointer transition-all duration-200 group">
                            <input type="radio" name="bill_type" value="gas" class="sr-only" onchange="selectBillType(this)">
                            <div class="flex items-center space-x-4 w-full">
                                <div class="w-12 h-12 bg-red-100 group-hover:bg-red-200 rounded-xl flex items-center justify-center transition-colors duration-200">
                                    <i class="fas fa-fire text-red-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Gas Bill</p>
                                    <p class="text-sm text-gray-500">Pay your gas bill with ease</p>
                                </div>
                            </div>
                            <div class="ml-auto">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                    <div class="w-3 h-3 bg-red-500 rounded-full hidden"></div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Connection Number -->
                <div class="space-y-3">
                    <label class="flex items-center text-lg font-semibold text-gray-800">
                        <i class="fas fa-plug mr-3 text-green-600"></i>Connection Number
                    </label>
                    <input type="text" 
                           name="connection_number" 
                           id="connectionNumber"
                           class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-200 bg-gray-50 focus:bg-white"
                           placeholder="Enter your connection number"
                           required>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            You can find your connection number on your electricity/gas bill or payment receipt
                        </p>
                    </div>
                </div>

                <!-- Service Provider Selection -->
                <div class="space-y-3">
                    <label class="flex items-center text-lg font-semibold text-gray-800">
                        <i class="fas fa-building mr-3 text-blue-600"></i>Select Service Provider
                    </label>
                    <select name="operator" 
                            id="operatorSelect"
                            class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 bg-gray-50 focus:bg-white"
                            required>
                        <option value="">Choose your service provider</option>
                        {% for operator in bill_operators %}
                            <option value="{{ operator.id }}" data-type="{{ operator.type }}">{{ operator.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Bill Fetch Section -->
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-dashed border-indigo-200 rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-indigo-900 flex items-center">
                                <i class="fas fa-search mr-3"></i>Fetch Bill Details
                            </h4>
                            <p class="text-indigo-700 mt-1">Get your exact bill amount and due date automatically</p>
                        </div>
                        <button type="button" 
                                onclick="fetchBill()"
                                id="fetchButton"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-search mr-2"></i>Fetch Bill
                        </button>
                    </div>
                    
                    <!-- Bill Details Display -->
                    <div id="billDetails" class="mt-6 hidden">
                        <div class="bg-white rounded-xl p-4 space-y-3 shadow-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Customer Name:</span>
                                <span class="font-semibold" id="customerName">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Bill Amount:</span>
                                <span class="font-semibold text-green-600 text-lg" id="billAmount">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Due Date:</span>
                                <span class="font-semibold text-red-600" id="dueDate">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Bill Date:</span>
                                <span class="font-semibold" id="billDate">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amount Input -->
                <div class="space-y-3">
                    <label class="flex items-center text-lg font-semibold text-gray-800">
                        <i class="fas fa-rupee-sign mr-3 text-purple-600"></i>Bill Amount
                    </label>
                    <input type="number" 
                           name="amount" 
                           id="amountInput"
                           class="w-full px-6 py-4 text-xl border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-200 bg-gray-50 focus:bg-white font-semibold"
                           placeholder="Enter bill amount"
                           min="50"
                           max="50000"
                           step="0.01"
                           required>
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-500">Minimum ‚Çπ50, Maximum ‚Çπ50,000</p>
                        <span id="amountValidation" class="text-sm"></span>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-8">
                    <button type="submit" 
                            id="submitButton"
                            class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white py-6 px-8 rounded-2xl font-bold text-xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                        <i class="fas fa-credit-card mr-3"></i>
                        <span id="buttonText">Pay Bill Now</span>
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Your payment will be processed instantly and securely
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Benefits Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-2xl p-6 text-center">
            <div class="bg-green-500 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-bolt text-white"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Instant Payment</h4>
            <p class="text-sm text-gray-600">Your bill is paid instantly with immediate confirmation</p>
        </div>
        
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-6 text-center">
            <div class="bg-blue-500 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-shield-alt text-white"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Secure Transactions</h4>
            <p class="text-sm text-gray-600">Bank-grade security with encrypted payment processing</p>
        </div>
        
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-2xl p-6 text-center">
            <div class="bg-purple-500 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-receipt text-white"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Digital Receipt</h4>
            <p class="text-sm text-gray-600">Get instant digital receipt for all your payments</p>
        </div>
    </div>
</div>

<script>
let walletBalance = {{ wallet_balance }};

// Select bill type function
function selectBillType(radio) {
    // Remove selection from all bill types
    document.querySelectorAll('input[name="bill_type"]').forEach(input => {
        const label = input.closest('label');
        const circle = label.querySelector('.w-6.h-6 div');
        label.classList.remove('border-yellow-500', 'bg-yellow-50', 'border-red-500', 'bg-red-50');
        label.classList.add('border-gray-200');
        circle.classList.add('hidden');
    });
    
    // Add selection to clicked bill type
    const label = radio.closest('label');
    const circle = label.querySelector('.w-6.h-6 div');
    const billType = radio.value;
    
    if (billType === 'electricity') {
        label.classList.add('border-yellow-500', 'bg-yellow-50');
    } else {
        label.classList.add('border-red-500', 'bg-red-50');
    }
    label.classList.remove('border-gray-200');
    circle.classList.remove('hidden');
    
    // Filter operators based on bill type
    filterOperators(billType);
}

// Filter operators function
function filterOperators(billType) {
    const operatorSelect = document.getElementById('operatorSelect');
    const options = operatorSelect.querySelectorAll('option[data-type]');
    
    options.forEach(option => {
        if (option.dataset.type === billType) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    operatorSelect.value = ''; // Reset selection
}

// Fetch bill function
function fetchBill() {
    const connectionNumber = document.getElementById('connectionNumber').value;
    const operator = document.getElementById('operatorSelect').value;
    const billType = document.querySelector('input[name="bill_type"]:checked');
    
    if (!connectionNumber || !operator || !billType) {
        Swal.fire({
            title: 'Missing Information',
            text: 'Please select bill type, enter connection number and select service provider first',
            icon: 'warning',
            confirmButtonColor: '#EAB308'
        });
        return;
    }
    
    const fetchButton = document.getElementById('fetchButton');
    fetchButton.disabled = true;
    fetchButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Fetching...';
    
    // Simulate API call
    setTimeout(() => {
        // Mock bill data
        const mockBill = {
            customerName: 'John Doe',
            billAmount: Math.floor(Math.random() * 2000) + 500, // Random amount between 500-2500
            dueDate: '25 Dec 2025',
            billDate: '15 Nov 2025'
        };
        
        // Display bill details
        document.getElementById('customerName').textContent = mockBill.customerName;
        document.getElementById('billAmount').textContent = '‚Çπ' + mockBill.billAmount.toFixed(2);
        document.getElementById('dueDate').textContent = mockBill.dueDate;
        document.getElementById('billDate').textContent = mockBill.billDate;
        document.getElementById('amountInput').value = mockBill.billAmount;
        
        document.getElementById('billDetails').classList.remove('hidden');
        
        fetchButton.disabled = false;
        fetchButton.innerHTML = '<i class="fas fa-check mr-2"></i>Bill Fetched';
        fetchButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        fetchButton.classList.add('bg-green-600', 'hover:bg-green-700');
        
        validateAmount();
        
        Swal.fire({
            title: 'Bill Details Fetched!',
            text: `Bill amount: ‚Çπ${mockBill.billAmount}`,
            icon: 'success',
            confirmButtonColor: '#10B981'
        });
    }, 2000);
}

// Amount validation
function validateAmount() {
    const amount = parseFloat(document.getElementById('amountInput').value);
    const validation = document.getElementById('amountValidation');
    
    if (!amount) {
        validation.textContent = '';
        validation.className = 'text-sm';
    } else if (amount < 50) {
        validation.textContent = '‚ùå Minimum amount is ‚Çπ50';
        validation.className = 'text-sm text-red-500';
    } else if (amount > 50000) {
        validation.textContent = '‚ùå Maximum amount is ‚Çπ50,000';
        validation.className = 'text-sm text-red-500';
    } else if (amount > walletBalance) {
        validation.textContent = '‚ùå Insufficient wallet balance';
        validation.className = 'text-sm text-red-500';
    } else {
        validation.textContent = '‚úÖ Valid amount';
        validation.className = 'text-sm text-green-500';
    }
}

document.getElementById('amountInput').addEventListener('input', validateAmount);

// Form validation
function validateBillForm(event) {
    event.preventDefault();
    
    const billType = document.querySelector('input[name="bill_type"]:checked');
    const connectionNumber = document.getElementById('connectionNumber').value;
    const operator = document.getElementById('operatorSelect').value;
    const amount = parseFloat(document.getElementById('amountInput').value);
    
    // Validate bill type
    if (!billType) {
        Swal.fire({
            title: 'Select Bill Type',
            text: 'Please select whether you want to pay electricity or gas bill',
            icon: 'warning',
            confirmButtonColor: '#EAB308'
        });
        return false;
    }
    
    // Validate connection number
    if (!connectionNumber) {
        Swal.fire({
            title: 'Enter Connection Number',
            text: 'Please enter your connection number',
            icon: 'error',
            confirmButtonColor: '#EAB308'
        });
        document.getElementById('connectionNumber').focus();
        return false;
    }
    
    // Validate operator
    if (!operator) {
        Swal.fire({
            title: 'Select Service Provider',
            text: 'Please select your service provider',
            icon: 'warning',
            confirmButtonColor: '#EAB308'
        });
        document.getElementById('operatorSelect').focus();
        return false;
    }
    
    // Validate amount
    if (!amount || amount < 50 || amount > 50000) {
        Swal.fire({
            title: 'Invalid Amount',
            text: 'Please enter amount between ‚Çπ50 and ‚Çπ50,000',
            icon: 'error',
            confirmButtonColor: '#EAB308'
        });
        document.getElementById('amountInput').focus();
        return false;
    }
    
    // Check wallet balance
    if (amount > walletBalance) {
        Swal.fire({
            title: 'Insufficient Balance',
            html: `Your wallet balance is ‚Çπ${walletBalance.toFixed(2)}<br>Required amount: ‚Çπ${amount.toFixed(2)}`,
            icon: 'error',
            showCancelButton: true,
            confirmButtonText: 'Add Money',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#10B981'
        }).then((result) => {
            if (result.isConfirmed) {
                addMoney();
            }
        });
        return false;
    }
    
    // Show confirmation dialog
    const operatorName = document.getElementById('operatorSelect').selectedOptions[0].text;
    const billTypeName = billType.value === 'electricity' ? 'Electricity' : 'Gas';
    
    Swal.fire({
        title: 'Confirm Bill Payment',
        html: `
            <div class="text-left space-y-3">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p><strong>Bill Type:</strong> ${billTypeName} Bill</p>
                    <p><strong>Connection:</strong> ${connectionNumber}</p>
                    <p><strong>Provider:</strong> ${operatorName}</p>
                    <p><strong>Amount:</strong> ‚Çπ${amount}</p>
                </div>
                <p class="text-center font-semibold text-green-600">
                    New balance will be: ‚Çπ${(```            <p class="text-center font-semibold text-green-600">
                New balance will be: ‚Çπ${(walletBalance - amount).toFixed(2)}
            </p>
        </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirm & Pay',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#10B981',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            processBillPayment();
        }
    });
    
    return false;
}

// Process bill payment
function processBillPayment() {
    Swal.fire({
        title: 'Processing Payment',
        html: `
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-green-600 mx-auto mb-4"></div>
                <p>Please wait while we process your payment...</p>
                <p class="text-sm text-gray-500">Almost done!</p>
            </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            setTimeout(() => {
                document.querySelector('form').submit();
            }, 3000);
        }
    });
}
</script>
{% endblock %}
