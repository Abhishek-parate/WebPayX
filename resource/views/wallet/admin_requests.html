<!-- templates/wallet/admin_requests.html -->
{% extends "base.html" %}

{% block title %}Wallet Top-up Requests{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <h1 class="page-title">Wallet Top-up Requests</h1>
                <div class="page-options">
                    <span class="badge badge-{{ current_user.role.value|lower }}">{{ current_user.role.value.replace('_', ' ').title() }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Filters</h4>
                </div>
                <div class="card-body">
                    <form method="GET" class="row">
                        <div class="col-md-2">
                            <label>Status</label>
                            <select name="status" class="form-control">
                                <option value="">All Status</option>
                                <option value="PENDING" {% if request.args.get('status') == 'PENDING' %}selected{% endif %}>Pending</option>
                                <option value="SUCCESS" {% if request.args.get('status') == 'SUCCESS' %}selected{% endif %}>Approved</option>
                                <option value="FAILED" {% if request.args.get('status') == 'FAILED' %}selected{% endif %}>Rejected</option>
                                <option value="PROCESSING" {% if request.args.get('status') == 'PROCESSING' %}selected{% endif %}>Processing</option>
                            </select>
                        </div>
                        {% if users %}
                        <div class="col-md-3">
                            <label>User</label>
                            <select name="user_id" class="form-control">
                                <option value="">All Users</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if request.args.get('user_id') == user.id|string %}selected{% endif %}>
                                    {{ user.full_name }} ({{ user.role.value.replace('_', ' ').title() }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        <div class="col-md-2">
                            <label>From Date</label>
                            <input type="date" name="from_date" class="form-control" value="{{ request.args.get('from_date', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label>To Date</label>
                            <input type="date" name="to_date" class="form-control" value="{{ request.args.get('to_date', '') }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary mr-2">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <a href="{{ url_for('wallet_management.requests') }}" class="btn btn-secondary mr-2">
                                <i class="fas fa-times"></i> Clear
                            </a>
                            <a href="{{ url_for('wallet_management.requests', export='csv', **request.args) }}" class="btn btn-success">
                                <i class="fas fa-download"></i> Export
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Requests Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        Requests 
                        {% if requests.total %}
                            ({{ requests.total }} total)
                        {% endif %}
                    </h4>
                    <div class="card-options">
                        {% if requests.has_prev or requests.has_next %}
                        <div class="btn-group">
                            {% if requests.has_prev %}
                            <a href="{{ url_for('wallet_management.requests', page=requests.prev_num, **request.args) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                            {% endif %}
                            <span class="btn btn-sm btn-light disabled">
                                Page {{ requests.page }} of {{ requests.pages }}
                            </span>
                            {% if requests.has_next %}
                            <a href="{{ url_for('wallet_management.requests', page=requests.next_num, **request.args) }}" 
                               class="btn btn-sm btn-outline-primary">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if requests.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Request ID</th>
                                    <th>User Details</th>
                                    <th>Amount & Method</th>
                                    <th>Transaction Details</th>
                                    <th>Status</th>
                                    <th>Date & Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in requests.items %}
                                <tr class="{% if req.status.value == 'PENDING' %}table-warning{% endif %}">
                                    <td>
                                        <strong class="text-primary">{{ req.request_id }}</strong>
                                        {% if req.is_expired %}
                                            <br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Expired</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm bg-gradient-primary rounded-circle text-white d-flex align-items-center justify-content-center mr-2">
                                                {{ req.user.full_name[:1].upper() }}
                                            </div>
                                            <div>
                                                <strong>{{ req.user.full_name }}</strong>
                                                <br><small class="text-muted">{{ req.user.user_code }}</small>
                                                <br><span class="badge badge-light badge-sm">{{ req.user.role.value.replace('_', ' ').title() }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong class="text-success">₹{{ "{:,.2f}".format(req.amount|float) }}</strong>
                                        {% if req.processing_fee > 0 %}
                                            <br><small class="text-muted">Fee: ₹{{ "{:,.2f}".format(req.processing_fee|float) }}</small>
                                        {% endif %}
                                        <br><span class="badge badge-info badge-sm">{{ req.topup_method.value.replace('_', ' ').title() }}</span>
                                    </td>
                                    <td>
                                        {% if req.transaction_mode %}
                                            <small><strong>Mode:</strong> {{ req.transaction_mode.value }}</small><br>
                                        {% endif %}
                                        {% if req.utr_number %}
                                            <small><strong>UTR:</strong> {{ req.utr_number }}</small><br>
                                        {% endif %}
                                        {% if req.bank_reference %}
                                            <small><strong>Bank Ref:</strong> {{ req.bank_reference }}</small><br>
                                        {% endif %}
                                        {% if req.selected_bank_account %}
                                            <small><strong>Bank:</strong> {{ req.selected_bank_account.bank_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set status_class = 'warning' if req.status.value == 'PENDING' else 'success' if req.status.value == 'SUCCESS' else 'danger' %}
                                        <span class="badge badge-{{ status_class }}">{{ req.status.value }}</span>
                                        {% if req.processed_at %}
                                            <br><small class="text-muted">{{ req.processed_at.strftime('%d %b %Y') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ req.created_at.strftime('%d %b %Y') }}</span>
                                        <br><small class="text-muted">{{ req.created_at.strftime('%I:%M %p') }}</small>
                                        {% if req.expires_at and req.status.value == 'PENDING' %}
                                            <br><small class="text-warning">Expires: {{ req.expires_at.strftime('%d %b') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('wallet_management.request_details', request_id=req.request_id) }}" 
                                               class="btn btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if req.status.value == 'PENDING' and not req.is_expired %}
                                            <button class="btn btn-outline-success" 
                                                    onclick="approveRequest('{{ req.request_id }}')" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="rejectRequest('{{ req.request_id }}')" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No requests found</h5>
                        <p class="text-muted">No wallet top-up requests match your current filters</p>
                        <a href="{{ url_for('wallet_management.requests') }}" class="btn btn-primary">
                            <i class="fas fa-refresh"></i> Clear Filters
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if requests.pages > 1 %}
    <div class="row mt-4">
        <div class="col-12 d-flex justify-content-center">
            <nav aria-label="Requests pagination">
                <ul class="pagination">
                    {% if requests.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('wallet_management.requests', page=1, **request.args) }}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('wallet_management.requests', page=requests.prev_num, **request.args) }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in requests.iter_pages() %}
                    {% if page_num %}
                    {% if page_num != requests.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('wallet_management.requests', page=page_num, **request.args) }}">{{ page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if requests.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('wallet_management.requests', page=requests.next_num, **request.args) }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('wallet_management.requests', page=requests.pages, **request.args) }}">Last</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Include modals from dashboard -->
<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="approvalForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Approve Request</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> This will approve the request and credit the amount to user's wallet.
                    </div>
                    <div class="form-group">
                        <label>Admin Remarks (Optional)</label>
                        <textarea name="remarks" class="form-control" rows="3" 
                                  placeholder="Add any remarks for this approval..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Approve & Credit Wallet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="rejectionForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Request</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> This action cannot be undone. Please provide a clear reason for rejection.
                    </div>
                    <div class="form-group">
                        <label>Rejection Reason <span class="text-danger">*</span></label>
                        <select name="reason" class="form-control mb-2" required>
                            <option value="">Select a reason</option>
                            <option value="Invalid payment proof">Invalid payment proof</option>
                            <option value="Insufficient bank details">Insufficient bank details</option>
                            <option value="Duplicate request">Duplicate request</option>
                            <option value="Policy violation">Policy violation</option>
                            <option value="Other">Other (specify in remarks)</option>
                        </select>
                        <textarea name="reason_details" class="form-control" rows="2" 
                                  placeholder="Additional details about the rejection..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Admin Remarks (Optional)</label>
                        <textarea name="remarks" class="form-control" rows="2" 
                                  placeholder="Internal remarks for admin reference..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Reject Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function approveRequest(requestId) {
    $('#approvalForm').attr('action', '{{ url_for("wallet_management.approve_request", request_id="PLACEHOLDER") }}'.replace('PLACEHOLDER', requestId));
    $('#approvalModal').modal('show');
}

function rejectRequest(requestId) {
    $('#rejectionForm').attr('action', '{{ url_for("wallet_management.reject_request", request_id="PLACEHOLDER") }}'.replace('PLACEHOLDER', requestId));
    $('#rejectionModal').modal('show');
}

// Auto-hide success/error messages
$(document).ready(function() {
    setTimeout(function() {
        $('.alert-dismissible').fadeOut();
    }, 5000);
});
</script>
{% endblock %}
