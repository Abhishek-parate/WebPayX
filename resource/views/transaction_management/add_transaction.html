{% extends 'layout/layout.html' %}
{% block content %}

<style>
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
</style>

<!-- Add Transaction Form -->
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Add New Transaction</h1>
        <p class="text-gray-600">Create a new transaction for a user wallet</p>
    </div>

    <div class="bg-white rounded-lg shadow border">
        <div class="p-6">
            <form method="POST" action="{{ url_for('transaction_management.add_transaction_page') }}">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Wallet Selection -->
                    <div class="lg:col-span-2">
                        <label for="wallet_id" class="block text-sm font-medium text-gray-700 mb-2">Select Wallet *</label>
                        <select name="wallet_id" id="wallet_id" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Choose a wallet...</option>
                            {% for wallet in wallets %}
                            <option value="{{ wallet.id }}" data-balance="{{ wallet.balance }}" data-available="{{ wallet.available_balance }}">
                                {{ wallet.user.username }} - {{ wallet.wallet_id }} (Balance: Rs. {{ "{:,.2f}".format(wallet.balance) }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Transaction Type -->
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Transaction Type *</label>
                        <select name="type" id="type" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Select type...</option>
                            {% for transaction_type in transaction_types %}
                            <option value="{{ transaction_type.value }}">{{ transaction_type.value.title() }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Status -->
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                        <select name="status" id="status" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            {% for status in transaction_statuses %}
                            <option value="{{ status.value }}" {% if status.value == 'PENDING' %}selected{% endif %}>
                                {{ status.value.title() }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Amount -->
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">Rs.</span>
                            </div>
                            <input type="number" name="amount" id="amount" step="0.01" min="0.01" required 
                                   placeholder="0.00"
                                   class="w-full pl-12 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <!-- Fees -->
                    <div>
                        <label for="fees" class="block text-sm font-medium text-gray-700 mb-2">Fees</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">Rs.</span>
                            </div>
                            <input type="number" name="fees" id="fees" step="0.01" min="0" 
                                   placeholder="0.00"
                                   class="w-full pl-12 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <!-- Tax Amount -->
                    <div>
                        <label for="tax_amount" class="block text-sm font-medium text-gray-700 mb-2">Tax Amount</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">Rs.</span>
                            </div>
                            <input type="number" name="tax_amount" id="tax_amount" step="0.01" min="0" 
                                   placeholder="0.00"
                                   class="w-full pl-12 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <!-- Reference Number -->
                    <div>
                        <label for="reference_number" class="block text-sm font-medium text-gray-700 mb-2">Reference Number</label>
                        <input type="text" name="reference_number" id="reference_number" 
                               placeholder="Internal reference number"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    </div>

                    <!-- External Reference -->
                    <div>
                        <label for="external_reference" class="block text-sm font-medium text-gray-700 mb-2">External Reference</label>
                        <input type="text" name="external_reference" id="external_reference" 
                               placeholder="External system reference"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    </div>

                    <!-- Description -->
                    <div class="lg:col-span-2">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" id="description" rows="3" 
                                  placeholder="Enter transaction description..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                </div>

                <!-- Balance Information -->
                <div id="balance-info" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Wallet Information</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Current Balance:</span>
                            <span id="current-balance" class="font-medium text-gray-900 ml-2">Rs. 0.00</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Available Balance:</span>
                            <span id="available-balance" class="font-medium text-gray-900 ml-2">Rs. 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Net Amount Display -->
                <div id="amount-summary" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                    <h4 class="text-sm font-medium text-blue-700 mb-2">Amount Summary</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-blue-600">Amount:</span>
                            <span id="display-amount" class="font-medium text-blue-900 ml-2">Rs. 0.00</span>
                        </div>
                        <div>
                            <span class="text-blue-600">Total Fees:</span>
                            <span id="display-fees" class="font-medium text-blue-900 ml-2">Rs. 0.00</span>
                        </div>
                        <div>
                            <span class="text-blue-600">Net Amount:</span>
                            <span id="display-net" class="font-medium text-blue-900 ml-2">Rs. 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-end gap-4 pt-6 border-t border-gray-200 mt-6">
                    <a href="{{ url_for('transaction_management.transactions_page') }}" 
                       class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        Create Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const walletSelect = document.getElementById('wallet_id');
    const typeSelect = document.getElementById('type');
    const amountInput = document.getElementById('amount');
    const feesInput = document.getElementById('fees');
    const taxInput = document.getElementById('tax_amount');
    const balanceInfo = document.getElementById('balance-info');
    const amountSummary = document.getElementById('amount-summary');

    // Update balance information when wallet is selected
    walletSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const balance = selectedOption.dataset.balance;
            const available = selectedOption.dataset.available;
            
            document.getElementById('current-balance').textContent = 'Rs. ' + parseFloat(balance).toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('available-balance').textContent = 'Rs. ' + parseFloat(available).toLocaleString('en-IN', {minimumFractionDigits: 2});
            
            balanceInfo.classList.remove('hidden');
            validateWithdrawal();
        } else {
            balanceInfo.classList.add('hidden');
        }
    });

    // Update amount summary when values change
    function updateAmountSummary() {
        const amount = parseFloat(amountInput.value) || 0;
        const fees = parseFloat(feesInput.value) || 0;
        const tax = parseFloat(taxInput.value) || 0;
        const totalFees = fees + tax;
        const netAmount = amount - totalFees;

        document.getElementById('display-amount').textContent = 'Rs. ' + amount.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('display-fees').textContent = 'Rs. ' + totalFees.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('display-net').textContent = 'Rs. ' + netAmount.toLocaleString('en-IN', {minimumFractionDigits: 2});

        if (amount > 0) {
            amountSummary.classList.remove('hidden');
        } else {
            amountSummary.classList.add('hidden');
        }

        validateWithdrawal();
    }

    // Validate withdrawal amount against available balance
    function validateWithdrawal() {
        const selectedWallet = walletSelect.options[walletSelect.selectedIndex];
        const transactionType = typeSelect.value;
        const amount = parseFloat(amountInput.value) || 0;

        if (selectedWallet.value && (transactionType === 'WITHDRAWAL' || transactionType === 'TRANSFER') && amount > 0) {
            const availableBalance = parseFloat(selectedWallet.dataset.available);
            
            if (amount > availableBalance) {
                amountInput.setCustomValidity('Amount exceeds available balance');
                amountInput.classList.add('border-red-500');
            } else {
                amountInput.setCustomValidity('');
                amountInput.classList.remove('border-red-500');
            }
        } else {
            amountInput.setCustomValidity('');
            amountInput.classList.remove('border-red-500');
        }
    }

    // Event listeners for amount calculation
    amountInput.addEventListener('input', updateAmountSummary);
    feesInput.addEventListener('input', updateAmountSummary);
    taxInput.addEventListener('input', updateAmountSummary);
    typeSelect.addEventListener('change', validateWithdrawal);
});
</script>

{% endblock %}