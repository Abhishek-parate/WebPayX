<!DOCTYPE html>
<html lang="en">

{% block head %}
{% include 'components/head.html' %}
{% endblock %}

<body class="dark:bg-neutral-800 bg-neutral-100 dark:text-white">
    <section class="bg-white dark:bg-dark-2 flex flex-wrap min-h-[100vh]">
        <div class="lg:w-1/2 lg:block hidden">
            <div class="flex items-center flex-col h-full justify-center">
                <img src="{{ url_for('static', filename='assets/images/auth/auth-img.png') }}" alt="">
            </div>
        </div>
        <div class="lg:w-1/2 py-8 px-6 flex flex-col justify-center">
            <div class="lg:max-w-[464px] mx-auto w-full">
                <div>
                    <a href="{{ url_for('dashboard') }}" class="mb-2.5 max-w-[290px]">
                        <img src="{{ url_for('static', filename='assets/images/logo.png') }}" alt="">
                    </a>
                    <h4 class="mb-3">Sign In to your Account</h4>
                    <p class="mb-8 text-secondary-light text-lg">Welcome back! please enter your detail</p>
                </div>

                <!-- Display Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} mb-4 p-3 rounded-lg">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Updated Form with proper action and CSRF protection -->
                <form id="signinForm" action="{{ url_for('authentication.signin_post') }}" method="POST">
                    {{ csrf_token() }}
                    
                    <div class="icon-field mb-4 relative">
                        <span class="absolute start-4 top-1/2 -translate-y-1/2 pointer-events-none flex text-xl">
                            <iconify-icon icon="mage:email"></iconify-icon>
                        </span>
                        <input type="text" name="username" id="username" 
                               class="form-control h-[56px] ps-11 border-neutral-300 bg-neutral-50 dark:bg-dark-2 rounded-xl" 
                               placeholder="Username, Email or Phone" required>
                    </div>
                    
                    <div class="relative mb-5">
                        <div class="icon-field">
                            <span class="absolute start-4 top-1/2 -translate-y-1/2 pointer-events-none flex text-xl">
                                <iconify-icon icon="solar:lock-password-outline"></iconify-icon>
                            </span>
                            <input type="password" name="password" id="password" 
                                   class="form-control h-[56px] ps-11 border-neutral-300 bg-neutral-50 dark:bg-dark-2 rounded-xl" 
                                   placeholder="Password" required>
                        </div>
                        <span class="toggle-password ri-eye-line cursor-pointer absolute end-0 top-1/2 -translate-y-1/2 me-4 text-secondary-light" data-toggle="#password"></span>
                    </div>

                    <!-- Hidden tenant field -->
                    <input type="hidden" name="tenant_code" value="DEFAULT">
                    
                    <div class="mt-7">
                        <div class="flex justify-between gap-2">
                            <div class="flex items-center">
                                <input class="form-check-input border border-neutral-300" type="checkbox" value="1" name="remember" id="remember">
                                <label class="ps-2" for="remember">Remember me</label>
                            </div>
                            <a href="{{ url_for('authentication.forgot_password') }}" class="text-primary-600 font-medium hover:underline">Forgot Password?</a>
                        </div>
                    </div>

                    <button type="submit" id="signinBtn" class="btn btn-primary justify-center text-sm btn-sm px-3 py-4 w-full rounded-xl mt-8">
                        <span class="signin-text">Sign In</span>
                        <span class="loading-text hidden">
                            <iconify-icon icon="line-md:loading-twotone-loop" class="animate-spin"></iconify-icon>
                            Signing in...
                        </span>
                    </button>

                    <div class="mt-8 center-border-horizontal text-center relative before:absolute before:w-full before:h-[1px] before:top-1/2 before:-translate-y-1/2 before:bg-neutral-300 before:start-0">
                        <span class="bg-white dark:bg-dark-2 z-[2] relative px-4">Or sign in with</span>
                    </div>
                    
                    <div class="mt-8 flex items-center gap-3">
                        <button type="button" class="font-semibold text-neutral-600 dark:text-neutral-200 py-4 px-6 w-1/2 border rounded-xl text-base flex items-center justify-center gap-3 line-height-1 hover:bg-primary-50">
                            <iconify-icon icon="ic:baseline-facebook" class="text-primary-600 text-xl line-height-1"></iconify-icon>
                            Facebook
                        </button>
                        <button type="button" class="font-semibold text-neutral-600 dark:text-neutral-200 py-4 px-6 w-1/2 border rounded-xl text-base flex items-center justify-center gap-3 line-height-1 hover:bg-primary-50">
                            <iconify-icon icon="logos:google-icon" class="text-primary-600 text-xl line-height-1"></iconify-icon>
                            Google
                        </button>
                    </div>
                    
                    <div class="mt-8 text-center text-sm">
                        <p class="mb-0">Don't have an account? <a href="{{ url_for('authentication.signup') }}" class="text-primary-600 font-semibold hover:underline">Sign Up</a></p>
                    </div>
                </form>
            </div>
        </div>
    </section>

    {% block script %}
    {% include 'components/script.html' %}
    {% endblock %}

    {% block custom_script %}
    <script>
        // Password Show Hide Functionality
        function initializePasswordToggle(toggleSelector) {
            $(toggleSelector).on("click", function() {
                $(this).toggleClass("ri-eye-off-line");
                var input = $($(this).attr("data-toggle"));
                if (input.attr("type") === "password") {
                    input.attr("type", "text");
                } else {
                    input.attr("type", "password");
                }
            });
        }
        initializePasswordToggle(".toggle-password");

        // Enhanced Form Submission with AJAX
        $(document).ready(function() {
            $('#signinForm').on('submit', function(e) {
                e.preventDefault();
                
                const form = $(this);
                const btn = $('#signinBtn');
                const formData = {
                    username: $('#username').val(),
                    password: $('#password').val(),
                    tenant_code: $('input[name="tenant_code"]').val(),
                    remember: $('#remember').is(':checked')
                };

                // Show loading state
                btn.prop('disabled', true);
                $('.signin-text').addClass('hidden');
                $('.loading-text').removeClass('hidden');

                // Clear previous alerts
                $('.alert').remove();

                $.ajax({
                    url: '{{ url_for("auth.login") }}',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.message === 'Login successful') {
                            // Store session token if needed
                            if (response.session_token) {
                                localStorage.setItem('session_token', response.session_token);
                            }
                            
                            // Show success message
                            form.before('<div class="alert alert-success mb-4 p-3 rounded-lg">Login successful! Redirecting...</div>');
                            
                            // Redirect to dashboard
                            setTimeout(() => {
                                window.location.href = '{{ url_for("dashboard") }}';
                            }, 1500);
                        }
                    },
                    error: function(xhr) {
                        const response = JSON.parse(xhr.responseText);
                        const errorMessage = response.error || 'Login failed. Please try again.';
                        
                        // Show error message
                        form.before('<div class="alert alert-danger mb-4 p-3 rounded-lg">' + errorMessage + '</div>');
                    },
                    complete: function() {
                        // Reset button state
                        btn.prop('disabled', false);
                        $('.signin-text').removeClass('hidden');
                        $('.loading-text').addClass('hidden');
                    }
                });
            });
        });
    </script>
    {% endblock %}

</body>
</html>
