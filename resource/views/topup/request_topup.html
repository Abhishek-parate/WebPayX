{% extends 'layout/layout.html' %} {% block content %}

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        animation: {
          'fade-in': 'fadeIn 0.3s ease-out',
          'slide-up': 'slideUp 0.2s ease-out',
          'pulse-slow': 'pulse 2s infinite',
        },
        keyframes: {
          fadeIn: {
            '0%': { opacity: '0', transform: 'translateY(8px)' },
            '100%': { opacity: '1', transform: 'translateY(0)' }
          },
          slideUp: {
            '0%': { transform: 'translateY(12px)', opacity: '0' },
            '100%': { transform: 'translateY(0)', opacity: '1' }
          }
        }
      }
    }
  }
</script>

<div class="min-h-screen bg-gray-50 py-6 px-4">
  <!-- Header Section -->
  <div class="max-w-5xl mx-auto mb-6 animate-fade-in">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 mb-1">{{ title }}</h1>
        <p class="text-gray-600">{{ subtitle }}</p>
      </div>
      <button onclick="window.history.back()" 
              class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 text-sm font-medium hover:bg-gray-50 transition-colors duration-150">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back
      </button>
    </div>
  </div>

  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Wallet Balance Card -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm animate-slide-up">
      <div class="border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="flex items-center mb-1">
              <svg class="w-5 h-5 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
              </svg>
              <h2 class="text-lg font-medium text-gray-900">Current Balance</h2>
            </div>
            <div class="text-2xl font-semibold text-gray-900" id="currentBalance">
              ₹{{ current_user.wallet.balance if current_user.wallet else '0.00' }}
            </div>
          </div>
          <div class="text-right">
            <div class="grid grid-cols-2 gap-6">
              <div>
                <div class="text-xs text-gray-500 mb-1">Daily Limit</div>
                <div class="text-sm font-medium text-gray-900">₹{{ current_user.wallet.daily_limit if current_user.wallet else '50,000' }}</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Monthly Limit</div>
                <div class="text-sm font-medium text-gray-900">₹{{ current_user.wallet.monthly_limit if current_user.wallet else '200,000' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Method Selection Card -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm animate-slide-up">
      <div class="border-b border-gray-200 px-6 py-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
          </svg>
          <h2 class="text-lg font-medium text-gray-900">Select Payment Method</h2>
        </div>
      </div>

      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <!-- Manual Payment Option -->
          <div class="payment-method-card relative cursor-pointer border-2 border-gray-200 rounded-lg p-6 hover:border-blue-400 hover:bg-blue-50 transition-all duration-200"
               onclick="selectPaymentMethod('manual')">
            <input type="radio" name="payment_method" value="manual" class="absolute top-4 right-4 w-4 h-4 text-blue-600" id="manual_payment" required>
            <div class="text-center">
              <div class="w-12 h-12 mx-auto mb-3 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                </svg>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Manual Payment</h3>
              <p class="text-sm text-gray-600">Transfer money to our bank account manually</p>
              <div class="mt-3 text-xs bg-yellow-50 text-yellow-800 px-3 py-2 rounded">
                Verification required
              </div>
            </div>
          </div>

          <!-- Online Payment Option -->
          <div class="payment-method-card relative cursor-pointer border-2 border-gray-200 rounded-lg p-6 hover:border-green-400 hover:bg-green-50 transition-all duration-200"
               onclick="selectPaymentMethod('online')">
            <input type="radio" name="payment_method" value="online" class="absolute top-4 right-4 w-4 h-4 text-green-600" id="online_payment" required>
            <div class="text-center">
              <div class="w-12 h-12 mx-auto mb-3 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Online Payment</h3>
              <p class="text-sm text-gray-600">Pay instantly using UPI or payment gateway</p>
              <div class="mt-3 text-xs bg-green-50 text-green-800 px-3 py-2 rounded">
                Instant processing
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Method Error -->
        <p id="paymentMethodError" class="mt-1 text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>

        <!-- Amount Selection (Common for both methods) -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2" for="amount">
            Top-up Amount <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="text-gray-500 font-medium">₹</span>
            </div>
            <input type="number" 
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150" 
                   id="amount" 
                   name="amount" 
                   inputmode="decimal"
                   min="10" 
                   max="100000" 
                   step="0.01" 
                   placeholder="Enter amount"
                   required
                   aria-describedby="amountError amountHelp"
                   aria-invalid="false">
          </div>
          <p id="amountHelp" class="text-sm text-gray-500 mt-1">Minimum: ₹10, Maximum: ₹100,000</p>
          <p id="amountError" class="mt-1 text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
        </div>
      </div>
    </div>

    <!-- Manual Payment Form -->
    <div id="manualPaymentForm" class="bg-white rounded-lg border border-gray-200 shadow-sm animate-slide-up hidden">
      <div class="border-b border-gray-200 px-6 py-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
          </svg>
          <h2 class="text-lg font-medium text-gray-900">Manual Payment Details</h2>
        </div>
      </div>

      <div class="p-6">
        <form id="manualTopupForm" enctype="multipart/form-data" class="space-y-6" novalidate>
          <!-- Bank Account Selection -->
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-700">
              Select Bank Account <span class="text-red-500">*</span>
            </label>
            <div class="space-y-3" id="bankAccountsContainer">
              {% for account in bank_accounts %}
              <div class="bank-account-card relative cursor-pointer border border-gray-300 rounded-md p-4 hover:border-gray-400 hover:bg-gray-50 transition-all duration-150"
                   onclick="selectBankAccount('{{ account.id }}')">
                <input type="radio" 
                       name="bank_account_id" 
                       value="{{ account.id }}" 
                       class="absolute top-4 right-4 w-4 h-4 text-blue-600" 
                       id="bank_{{ account.id }}"
                       aria-describedby="bankAccountError">
                
                <div class="space-y-2 pr-8">
                  <div class="flex items-center justify-between">
                    <h3 class="font-medium text-gray-900">{{ account.account_name }}</h3>
                    {% if account.is_default_topup %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">
                      Recommended
                    </span>
                    {% endif %}
                  </div>
                  
                  <div class="space-y-1 text-sm text-gray-600">
                    <p class="font-medium text-gray-800">{{ account.bank_name }}</p>
                    <div class="flex items-center space-x-4">
                      <span class="flex items-center">
                        <span class="font-medium mr-1">A/C:</span>
                        <span class="font-mono text-xs">{{ account.account_number }}</span>
                      </span>
                      <span class="flex items-center">
                        <span class="font-medium mr-1">IFSC:</span>
                        <span class="font-mono text-xs">{{ account.ifsc_code }}</span>
                      </span>
                    </div>
                    {% if account.upi_id %}
                    <div class="flex items-center text-blue-600">
                      <span class="font-medium mr-1">UPI:</span>
                      <span class="font-mono text-xs">{{ account.upi_id }}</span>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <p id="bankAccountError" class="mt-1 text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
          </div>

          <!-- Transaction Details -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700" for="transactionId">
                Transaction Reference/UTR <span class="text-red-500">*</span>
              </label>
              <input type="text" 
                     class="w-full px-3 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150" 
                     id="transactionId" 
                     name="transaction_id" 
                     placeholder="Enter UTR/Reference Number"
                     pattern="^[A-Za-z0-9\-]{8,25}$"
                     maxlength="25"
                     minlength="8"
                     aria-describedby="utrError utrHelp"
                     aria-invalid="false">
              <p id="utrHelp" class="text-sm text-gray-500">Enter bank reference number after transfer (8-25 characters)</p>
              <p id="utrError" class="mt-1 text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700" for="remarks">Remarks</label>
              <textarea class="w-full px-3 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-colors duration-150" 
                        id="remarks" 
                        name="remarks" 
                        rows="3" 
                        maxlength="200"
                        placeholder="Additional notes or remarks"
                        aria-describedby="remarksError remarksCounter"
                        aria-invalid="false"></textarea>
              <div class="flex justify-between items-center">
                <p id="remarksCounter" class="text-xs text-gray-500">0/200 characters</p>
                <p id="remarksError" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
              </div>
            </div>
          </div>

          <!-- File Upload -->
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-700" for="proofDocument">
              Payment Proof Document <span class="text-red-500">*</span>
            </label>
            <div class="upload-area relative border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:border-gray-400 hover:bg-gray-50 transition-colors duration-150 cursor-pointer"
                 onclick="document.getElementById('proofDocument').click()">
              <div class="space-y-3">
                <div class="mx-auto w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-medium text-gray-900 mb-1">Upload Payment Proof</h3>
                  <p class="text-sm text-gray-500">PNG, JPG, JPEG, PDF (Max 5MB)</p>
                </div>
              </div>
              <input type="file" 
                     class="hidden" 
                     id="proofDocument" 
                     name="proof_document" 
                     accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf"
                     aria-describedby="fileError fileHelp"
                     aria-invalid="false">
            </div>
            <p id="fileHelp" class="text-sm text-gray-500">Accepted formats: PNG, JPG, JPEG, PDF. Maximum size: 5MB</p>
            <p id="fileError" class="mt-1 text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
            <div id="filePreview" class="mt-3"></div>
          </div>
        </form>
      </div>
    </div>

    <!-- Online Payment Form -->
    <div id="onlinePaymentForm" class="bg-white rounded-lg border border-gray-200 shadow-sm animate-slide-up hidden">
      <div class="border-b border-gray-200 px-6 py-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
          </svg>
          <h2 class="text-lg font-medium text-gray-900">Online Payment</h2>
        </div>
      </div>

      <div class="p-6">
        <form id="onlineTopupForm" class="space-y-6" novalidate>
          <!-- UPI Payment Section -->
          <div class="text-center">
            <div class="mb-4">
              <h3 class="text-lg font-medium text-gray-900 mb-2">Scan QR Code to Pay</h3>
              <p class="text-sm text-gray-600">Use any UPI app to scan and pay</p>
            </div>
            
            <!-- QR Code Display -->
            <div class="inline-block p-4 bg-white border-2 border-gray-200 rounded-lg shadow-sm">
              <div id="qrCodeContainer" class="w-48 h-48 mx-auto mb-3 bg-gray-100 rounded-lg flex items-center justify-center">
                <div class="text-center">
                  <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-.01m-4 0h4.01m4.01 0h.01M12 8h4.01m-4.01 0h.01m-4 0h4.01M8 12h.01M8 8h.01"/>
                  </svg>
                  <p class="text-sm text-gray-500">QR Code will appear here</p>
                </div>
              </div>
              <div class="text-sm text-gray-600">
                Amount: <span id="qrAmount" class="font-medium">₹0.00</span>
              </div>
            </div>

            <!-- UPI ID Display -->
            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
              <p class="text-sm text-gray-700 mb-2">Or pay using UPI ID:</p>
              <div class="flex items-center justify-center space-x-2">
                <span id="upiId" class="font-mono text-lg text-blue-600" data-upi="payment@company.upi">payment@company.upi</span>
                <button type="button" onclick="copyUpiId()" class="p-1 text-blue-600 hover:text-blue-800">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Payment Instructions -->
            <div class="mt-6 text-left">
              <h4 class="font-medium text-gray-900 mb-3">Payment Instructions:</h4>
              <ol class="text-sm text-gray-600 space-y-2">
                <li class="flex items-start">
                  <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 text-xs font-medium flex items-center justify-center mr-3 mt-0.5">1</span>
                  Open any UPI app (GPay, PhonePe, Paytm, etc.)
                </li>
                <li class="flex items-start">
                  <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 text-xs font-medium flex items-center justify-center mr-3 mt-0.5">2</span>
                  Scan the QR code or enter the UPI ID
                </li>
                <li class="flex items-start">
                  <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 text-xs font-medium flex items-center justify-center mr-3 mt-0.5">3</span>
                  Enter the exact amount and complete payment
                </li>
                <li class="flex items-start">
                  <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 text-xs font-medium flex items-center justify-center mr-3 mt-0.5">4</span>
                  Your wallet will be credited automatically
                </li>
              </ol>
            </div>

            <!-- Status Indicator -->
            <div id="paymentStatus" class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
              <div class="flex items-center justify-center">
                <svg class="animate-spin w-5 h-5 text-yellow-600 mr-3" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-yellow-800">Waiting for payment confirmation...</span>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Submit Button Section -->
    <div id="submitSection" class="bg-white rounded-lg border border-gray-200 shadow-sm animate-slide-up hidden">
      <div class="p-6">
        <div class="flex flex-col sm:flex-row gap-3 justify-end">
          <button type="button" 
                  onclick="resetForm()"
                  class="sm:w-auto px-6 py-2.5 border border-gray-300 rounded-md text-gray-700 text-sm font-medium hover:bg-gray-50 transition-colors duration-150">
            Reset Form
          </button>
          <button type="button" 
                  id="submitBtn"
                  onclick="submitForm()"
                  class="flex-1 sm:flex-none px-8 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-150">
            <span id="submitBtnText">Submit Request</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-200 scale-95 opacity-0" id="modalContent">
    <div class="border-b border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <svg class="w-6 h-6 mr-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <h3 class="text-lg font-medium text-gray-900">Request Submitted</h3>
        </div>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors duration-150">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="p-6">
      <div class="text-center mb-6">
        <div class="w-12 h-12 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
        </div>
        
        <h4 class="text-lg font-medium text-gray-900 mb-3">Your top-up request has been submitted</h4>
        <div class="space-y-1 mb-4">
          <p class="text-sm text-gray-600">Request ID: <span class="font-mono font-medium text-gray-900" id="requestId"></span></p>
          <p class="text-sm text-gray-600">Amount: <span class="font-medium text-gray-900">₹<span id="requestAmount"></span></span></p>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-md p-3 text-left">
          <div class="flex items-start">
            <svg class="w-4 h-4 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <p class="text-blue-800 text-sm" id="modalMessage">Your request is pending approval. You will be notified once it's processed.</p>
          </div>
        </div>
      </div>
      
      <div class="flex flex-col sm:flex-row gap-3">
        <button onclick="window.location.href='{{ url_for('enhanced_topup.topup_history_page') }}'"
                class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 text-sm font-medium hover:bg-gray-50 transition-colors duration-150">
          View History
        </button>
        <button onclick="window.location.href='{{ url_for('enhanced_topup.topup_request_page') }}'"
                class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors duration-150">
          New Request
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedPaymentMethod = null;
  let selectedBankAccount = null;

  // Validation constants and utilities
  const VALID_FILE_TYPES = ['image/png', 'image/jpeg', 'application/pdf'];
  const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB
  const UPI_REGEX = /^[a-zA-Z0-9._-]{2,256}@[a-zA-Z]{2,64}$/;
  const UTR_REGEX = /^[A-Za-z0-9\-]{8,25}$/;
  const AMOUNT_REGEX = /^\d+(\.\d{1,2})?$/;

  // Enhanced error handling utilities
  function setError(element, message, errorElementId) {
    element.setCustomValidity(message);
    element.setAttribute('aria-invalid', 'true');
    element.classList.add('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
    element.classList.remove('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
    
    const errorElement = document.getElementById(errorElementId);
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }
    return false;
  }

  function clearError(element, errorElementId) {
    element.setCustomValidity('');
    element.setAttribute('aria-invalid', 'false');
    element.classList.remove('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
    element.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
    
    const errorElement = document.getElementById(errorElementId);
    if (errorElement) {
      errorElement.textContent = '';
      errorElement.classList.add('hidden');
    }
    return true;
  }

  // Advanced validation functions
  function validateAmount() {
    const element = document.getElementById('amount');
    const value = element.value.trim();
    
    if (!value) {
      return setError(element, 'Amount is required.', 'amountError');
    }
    
    // Check for valid number format
    if (!AMOUNT_REGEX.test(value)) {
      return setError(element, 'Please enter a valid amount with up to 2 decimal places.', 'amountError');
    }
    
    const numValue = parseFloat(value);
    
    if (isNaN(numValue) || !isFinite(numValue)) {
      return setError(element, 'Please enter a valid number.', 'amountError');
    }
    
    if (numValue <= 0) {
      return setError(element, 'Amount must be greater than 0.', 'amountError');
    }
    
    if (numValue < 10) {
      return setError(element, 'Minimum amount is ₹10.', 'amountError');
    }
    
    if (numValue > 100000) {
      return setError(element, 'Maximum amount is ₹100,000.', 'amountError');
    }
    
    // Check for too many decimal places
    const decimalPlaces = (value.split('.')[1] || '').length;
    if (decimalPlaces > 2) {
      return setError(element, 'Amount cannot have more than 2 decimal places.', 'amountError');
    }
    
    // Check for reasonable precision
    if (numValue < 0.01) {
      return setError(element, 'Amount must be at least ₹0.01.', 'amountError');
    }
    
    return clearError(element, 'amountError');
  }

  function validatePaymentMethod() {
    const manualRadio = document.getElementById('manual_payment');
    const onlineRadio = document.getElementById('online_payment');
    const errorElement = document.getElementById('paymentMethodError');
    
    if (!selectedPaymentMethod || (!manualRadio.checked && !onlineRadio.checked)) {
      if (errorElement) {
        errorElement.textContent = 'Please select a payment method.';
        errorElement.classList.remove('hidden');
      }
      return false;
    }
    
    if (errorElement) {
      errorElement.textContent = '';
      errorElement.classList.add('hidden');
    }
    return true;
  }

  function validateUTR() {
    const element = document.getElementById('transactionId');
    const value = element.value.trim();
    
    if (selectedPaymentMethod !== 'manual') {
      return clearError(element, 'utrError');
    }
    
    if (!value) {
      return setError(element, 'Transaction Reference/UTR is required for manual payments.', 'utrError');
    }
    
    if (value.length < 8) {
      return setError(element, 'UTR must be at least 8 characters long.', 'utrError');
    }
    
    if (value.length > 25) {
      return setError(element, 'UTR cannot exceed 25 characters.', 'utrError');
    }
    
    if (!UTR_REGEX.test(value)) {
      return setError(element, 'Invalid UTR format. Use only letters, numbers, and hyphens.', 'utrError');
    }
    
    // Check for suspicious patterns
    if (/^(.)\1{7,}$/.test(value)) {
      return setError(element, 'UTR appears to be invalid (repeated characters).', 'utrError');
    }
    
    return clearError(element, 'utrError');
  }

  function validateRemarks() {
    const element = document.getElementById('remarks');
    const value = element.value;
    const counter = document.getElementById('remarksCounter');
    
    // Update character counter
    if (counter) {
      const remaining = 200 - value.length;
      counter.textContent = `${value.length}/200 characters`;
      counter.className = remaining < 20 ? 'text-xs text-red-500' : 'text-xs text-gray-500';
    }
    
    if (value.length > 200) {
      return setError(element, 'Remarks cannot exceed 200 characters.', 'remarksError');
    }
    
    // Check for suspicious content
    if (/<script|javascript:|on\w+=/i.test(value)) {
      return setError(element, 'Remarks contain invalid characters.', 'remarksError');
    }
    
    return clearError(element, 'remarksError');
  }

  function validateFile() {
    const element = document.getElementById('proofDocument');
    const files = element.files;
    
    if (selectedPaymentMethod !== 'manual') {
      return clearError(element, 'fileError');
    }
    
    if (!files || files.length === 0) {
      return setError(element, 'Payment proof document is required for manual payments.', 'fileError');
    }
    
    const file = files[0];
    
    // Check file size
    if (file.size > MAX_FILE_BYTES) {
      return setError(element, `File size must be ${MAX_FILE_BYTES / (1024 * 1024)}MB or less. Current size: ${(file.size / (1024 * 1024)).toFixed(2)}MB`, 'fileError');
    }
    
    if (file.size === 0) {
      return setError(element, 'File appears to be empty or corrupted.', 'fileError');
    }
    
    // Check file type
    if (!VALID_FILE_TYPES.includes(file.type)) {
      return setError(element, `Invalid file type: ${file.type}. Only PNG, JPG, JPEG, and PDF files are allowed.`, 'fileError');
    }
    
    // Additional file name validation
    const fileName = file.name.toLowerCase();
    const allowedExtensions = ['.png', '.jpg', '.jpeg', '.pdf'];
    const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
    
    if (!hasValidExtension) {
      return setError(element, 'File must have a valid extension (.png, .jpg, .jpeg, .pdf).', 'fileError');
    }
    
    // Check file name for suspicious patterns
    if (fileName.length > 255) {
      return setError(element, 'File name is too long.', 'fileError');
    }
    
    if (/[<>:"|*?\\\/]/.test(fileName.replace(/\.(png|jpg|jpeg|pdf)$/, ''))) {
      return setError(element, 'File name contains invalid characters.', 'fileError');
    }
    
    return clearError(element, 'fileError');
  }

  function validateBankAccount() {
    const errorElement = document.getElementById('bankAccountError');
    
    if (selectedPaymentMethod === 'manual' && !selectedBankAccount) {
      if (errorElement) {
        errorElement.textContent = 'Please select a bank account for manual payment.';
        errorElement.classList.remove('hidden');
      }
      return false;
    }
    
    if (errorElement) {
      errorElement.textContent = '';
      errorElement.classList.add('hidden');
    }
    return true;
  }

  function validateUPI(upiId) {
    return UPI_REGEX.test(upiId);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Real-time validation with debouncing
  const debouncedValidateAmount = debounce(validateAmount, 300);
  const debouncedValidateUTR = debounce(validateUTR, 300);
  const debouncedValidateRemarks = debounce(validateRemarks, 300);

  // Event listeners
  document.getElementById('amount').addEventListener('input', function() {
    debouncedValidateAmount();
    updatePaymentInfo();
  });

  document.getElementById('amount').addEventListener('blur', validateAmount);
  document.getElementById('amount').addEventListener('paste', function() {
    setTimeout(validateAmount, 10);
  });

  document.getElementById('transactionId').addEventListener('input', debouncedValidateUTR);
  document.getElementById('transactionId').addEventListener('blur', validateUTR);

  document.getElementById('remarks').addEventListener('input', function() {
    validateRemarks();
    debouncedValidateRemarks();
  });

  document.getElementById('proofDocument').addEventListener('change', function() {
    validateFile();
    handleFileSelect(this);
  });

  // Enhanced existing functions with validation
  function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Remove selected styling from all cards
    document.querySelectorAll('.payment-method-card').forEach(card => {
      card.classList.remove('border-blue-600', 'bg-blue-50', 'border-green-600', 'bg-green-50');
      card.classList.add('border-gray-200');
    });
    
    // Add selected styling to clicked card
    const selectedCard = event.currentTarget;
    if (method === 'manual') {
      selectedCard.classList.remove('border-gray-200');
      selectedCard.classList.add('border-blue-600', 'bg-blue-50');
      document.getElementById('manual_payment').checked = true;
      showManualPaymentForm();
      
      // Make manual fields required
      document.getElementById('transactionId').setAttribute('required', '');
      document.getElementById('proofDocument').setAttribute('required', '');
    } else {
      selectedCard.classList.remove('border-gray-200');
      selectedCard.classList.add('border-green-600', 'bg-green-50');
      document.getElementById('online_payment').checked = true;
      showOnlinePaymentForm();
      
      // Remove required from manual fields
      document.getElementById('transactionId').removeAttribute('required');
      document.getElementById('proofDocument').removeAttribute('required');
    }
    
    // Clear payment method error
    validatePaymentMethod();
    
    // Revalidate context-dependent fields
    validateUTR();
    validateFile();
    validateBankAccount();
    
    document.getElementById('submitSection').classList.remove('hidden');
  }

  function selectBankAccount(bankId) {
    // Remove selected styling from all cards
    document.querySelectorAll('.bank-account-card').forEach(card => {
      card.classList.remove('border-blue-600', 'bg-blue-50');
      card.classList.add('border-gray-300');
    });
    
    // Add selected styling to clicked card
    const selectedCard = event.currentTarget;
    selectedCard.classList.remove('border-gray-300');
    selectedCard.classList.add('border-blue-600', 'bg-blue-50');
    
    // Check the radio button
    document.getElementById(`bank_${bankId}`).checked = true;
    selectedBankAccount = bankId;
    
    // Validate bank account selection
    validateBankAccount();
  }

  function updatePaymentInfo() {
    if (!validateAmount()) {
      document.getElementById('qrAmount').textContent = '₹0.00';
      return;
    }
    
    const amount = parseFloat(document.getElementById('amount').value);
    if (selectedPaymentMethod === 'online') {
      document.getElementById('qrAmount').textContent = `₹${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      generateQRCode(amount);
    }
  }

  function generateQRCode(amount) {
    if (!Number.isFinite(amount) || amount <= 0) return;
    
    const upiSpan = document.getElementById('upiId');
    const upiId = upiSpan?.dataset?.upi || upiSpan?.textContent || '';
    
    // Validate UPI ID if provided
    if (upiId && !validateUPI(upiId)) {
      console.warn('Invalid UPI ID format detected:', upiId);
    }
    
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = `
      <div class="w-full h-full bg-white border rounded flex items-center justify-center">
        <div class="text-center">
          <div class="grid grid-cols-8 gap-1 mx-auto" style="width: 120px; height: 120px;">
            ${generateQRPattern()}
          </div>
          <p class="text-xs text-gray-500 mt-2">QR Code for ₹${amount.toFixed(2)}</p>
        </div>
      </div>
    `;
  }

  function generateQRPattern() {
    // Generate a simple QR-like pattern for demo
    let pattern = '';
    for (let i = 0; i < 64; i++) {
      const isBlack = Math.random() > 0.5;
      pattern += `<div class="w-1.5 h-1.5 ${isBlack ? 'bg-black' : 'bg-white'}"></div>`;
    }
    return pattern;
  }

  function handleFileSelect(input) {
    const isValid = validateFile();
    const preview = document.getElementById('filePreview');
    
    if (!isValid || !input.files.length) {
      preview.innerHTML = '';
      return;
    }
    
    const file = input.files[0];
    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
    const fileIcon = getFileIcon(file.type);
    
    preview.innerHTML = `
      <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-md">
        <div class="flex-shrink-0 mr-3">${fileIcon}</div>
        <div class="flex-1">
          <p class="text-sm font-medium text-green-800" title="${file.name}">${file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name}</p>
          <p class="text-sm text-green-600">${fileSizeMB} MB • ${file.type}</p>
        </div>
        <button type="button" onclick="clearFileSelection()" class="text-green-600 hover:text-green-800 transition-colors duration-150" title="Remove file">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    `;
  }

  function getFileIcon(fileType) {
    if (fileType === 'application/pdf') {
      return '<svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/></svg>';
    } else if (fileType.startsWith('image/')) {
      return '<svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/></svg>';
    } else {
      return '<svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/></svg>';
    }
  }

  function clearFileSelection() {
    const fileInput = document.getElementById('proofDocument');
    fileInput.value = '';
    document.getElementById('filePreview').innerHTML = '';
    clearError(fileInput, 'fileError');
  }

  function copyUpiId() {
    const upiId = document.getElementById('upiId').textContent;
    
    if (!validateUPI(upiId)) {
      alert('Invalid UPI ID format');
      return;
    }
    
    navigator.clipboard.writeText(upiId).then(() => {
      const button = event.currentTarget;
      const originalContent = button.innerHTML;
      button.innerHTML = '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
      setTimeout(() => {
        button.innerHTML = originalContent;
      }, 2000);
    }).catch((err) => {
      console.error('Failed to copy UPI ID:', err);
      alert('Failed to copy UPI ID. Please copy manually.');
    });
  }

  // Enhanced form submission with comprehensive validation
  function submitForm() {
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Prevent double submission
    if (submitBtn.disabled) return;
    
    // Run all validations
    const validations = [
      validateAmount(),
      validatePaymentMethod(),
      validateUTR(),
      validateRemarks(),
      validateFile(),
      validateBankAccount()
    ];
    
    const isAllValid = validations.every(result => result === true);
    
    // Check form validity using native HTML5 validation
    const manualForm = document.getElementById('manualTopupForm');
    const onlineForm = document.getElementById('onlineTopupForm');
    const isManualVisible = !document.getElementById('manualPaymentForm').classList.contains('hidden');
    const isOnlineVisible = !document.getElementById('onlinePaymentForm').classList.contains('hidden');
    
    let isNativeValid = true;
    if (isManualVisible && !manualForm.checkValidity()) {
      manualForm.reportValidity();
      isNativeValid = false;
    }
    if (isOnlineVisible && !onlineForm.checkValidity()) {
      onlineForm.reportValidity();
      isNativeValid = false;
    }
    
    // Stop if validation fails
    if (!isAllValid || !isNativeValid) {
      // Scroll to first error
      const firstError = document.querySelector('.border-red-300, [aria-invalid="true"]');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
      return;
    }
    
    // Additional security validation
    const amount = parseFloat(document.getElementById('amount').value);
    if (!Number.isFinite(amount) || amount < 10 || amount > 100000) {
      setError(document.getElementById('amount'), 'Invalid amount detected. Please refresh and try again.', 'amountError');
      return;
    }
    
    if (selectedPaymentMethod === 'manual') {
      submitManualPayment(submitBtn, originalText);
    } else {
      submitOnlinePayment(submitBtn, originalText);
    }
  }

  // Rest of the existing functions...
  function showManualPaymentForm() {
    document.getElementById('manualPaymentForm').classList.remove('hidden');
    document.getElementById('onlinePaymentForm').classList.add('hidden');
    updateSubmitButton('Submit Manual Request');
  }

  function showOnlinePaymentForm() {
    document.getElementById('onlinePaymentForm').classList.remove('hidden');
    document.getElementById('manualPaymentForm').classList.add('hidden');
    updateSubmitButton('Proceed to Payment');
    updatePaymentInfo();
  }

  function updateSubmitButton(text) {
    document.getElementById('submitBtnText').textContent = text;
  }

  function resetForm() {
    // Reset payment method selection
    selectedPaymentMethod = null;
    selectedBankAccount = null;
    
    document.querySelectorAll('.payment-method-card').forEach(card => {
      card.classList.remove('border-blue-600', 'bg-blue-50', 'border-green-600', 'bg-green-50');
      card.classList.add('border-gray-200');
    });
    
    document.querySelectorAll('input[name="payment_method"]').forEach(input => {
      input.checked = false;
    });
    
    // Reset forms and clear errors
    document.getElementById('manualTopupForm').reset();
    document.getElementById('onlineTopupForm').reset();
    
    // Clear all validation errors
    ['amount', 'transactionId', 'remarks', 'proofDocument'].forEach(id => {
      const element = document.getElementById(id);
      const errorId = id + 'Error';
      if (element) clearError(element, errorId);
    });
    
    // Clear additional errors
    const additionalErrors = ['paymentMethodError', 'bankAccountError'];
    additionalErrors.forEach(errorId => {
      const errorElement = document.getElementById(errorId);
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.add('hidden');
      }
    });
    
    // Reset character counter
    const counter = document.getElementById('remarksCounter');
    if (counter) {
      counter.textContent = '0/200 characters';
      counter.className = 'text-xs text-gray-500';
    }
    
    // Reset bank account selection
    document.querySelectorAll('.bank-account-card').forEach(card => {
      card.classList.remove('border-blue-600', 'bg-blue-50');
      card.classList.add('border-gray-300');
    });
    
    // Hide forms
    document.getElementById('manualPaymentForm').classList.add('hidden');
    document.getElementById('onlinePaymentForm').classList.add('hidden');
    document.getElementById('submitSection').classList.add('hidden');
    
    // Clear file selection
    clearFileSelection();
    
    // Reset QR code
    document.getElementById('qrCodeContainer').innerHTML = `
      <div class="text-center">
        <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-.01m-4 0h4.01m4.01 0h.01M12 8h4.01m-4.01 0h.01m-4 0h4.01M8 12h.01M8 8h.01"/>
        </svg>
        <p class="text-sm text-gray-500">QR Code will appear here</p>
      </div>
    `;
    document.getElementById('qrAmount').textContent = '₹0.00';
  }

  // Enhanced drag and drop functionality with validation
  const uploadArea = document.querySelector('.upload-area');
  
  if (uploadArea) {
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add('border-blue-400', 'bg-blue-50');
      uploadArea.classList.remove('border-gray-300');
    });

    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
      uploadArea.classList.add('border-gray-300');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
      uploadArea.classList.add('border-gray-300');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const fileInput = document.getElementById('proofDocument');
        fileInput.files = files;
        validateFile();
        handleFileSelect(fileInput);
      }
    });
  }

  function submitManualPayment(submitBtn, originalText) {
    // Show loading state
    submitBtn.innerHTML = `
      <svg class="animate-spin w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Submitting...
    `;
    submitBtn.disabled = true;
    
    // Create form data with validation
    const formData = new FormData(document.getElementById('manualTopupForm'));
    const amount = parseFloat(document.getElementById('amount').value);
    
    formData.append('amount', amount.toFixed(2));
    formData.append('topup_method', 'MANUAL_REQUEST');
    formData.append('client_validation', 'passed');
    
    // Submit request
    fetch('/topup/api/request', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      
      // Show success modal
      document.getElementById('requestId').textContent = data.request_id || 'N/A';
      document.getElementById('requestAmount').textContent = amount.toLocaleString('en-IN', {minimumFractionDigits: 2});
      document.getElementById('modalMessage').textContent = 'Your manual payment request is pending verification. Please wait for admin approval.';
      
      showModal();
      resetForm();
    })
    .catch(error => {
      console.error('Submission error:', error);
      alert('Error: ' + (error.message || 'An unexpected error occurred. Please try again.'));
    })
    .finally(() => {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
  }

  function submitOnlinePayment(submitBtn, originalText) {
    // Show loading state
    submitBtn.innerHTML = `
      <svg class="animate-spin w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Processing...
    `;
    submitBtn.disabled = true;
    
    // Show payment status
    document.getElementById('paymentStatus').classList.remove('hidden');
    
    const amount = parseFloat(document.getElementById('amount').value);
    
    // Create payment request data
    const paymentData = {
      amount: amount.toFixed(2),
      topup_method: 'PAYMENT_GATEWAY',
      payment_type: 'UPI',
      client_validation: 'passed'
    };
    
    // Submit online payment request
    fetch('/topup/api/request', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(paymentData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      
      setTimeout(() => {
        document.getElementById('paymentStatus').classList.add('hidden');
        
        // Show success modal
        document.getElementById('requestId').textContent = data.request_id || 'N/A';
        document.getElementById('requestAmount').textContent = amount.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('modalMessage').textContent = 'Payment completed successfully. Your wallet will be credited shortly.';
        
        showModal();
        resetForm();
      }, 3000);
    })
    .catch(error => {
      document.getElementById('paymentStatus').classList.add('hidden');
      console.error('Payment error:', error);
      alert('Error: ' + (error.message || 'Payment failed. Please try again.'));
    })
    .finally(() => {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
  }

  function showModal() {
    const modal = document.getElementById('successModal');
    const modalContent = document.getElementById('modalContent');
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // Focus management for accessibility
    modalContent.focus();
  }

  function closeModal() {
    const modal = document.getElementById('successModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.classList.add('scale-95', 'opacity-0');
    modalContent.classList.remove('scale-100', 'opacity-100');
    
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 200);
  }

  // Close modal on outside click and escape key
  document.getElementById('successModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('successModal').classList.contains('hidden')) {
      closeModal();
    }
  });

  // Initialize form state on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Set up initial validation state
    validateAmount();
    validatePaymentMethod();
    
    // Prevent form submission on Enter key (except for submit button)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.tagName !== 'BUTTON' && e.target.type !== 'submit') {
        e.preventDefault();
      }
    });
  });
</script>

{% endblock %}
