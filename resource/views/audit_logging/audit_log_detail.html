<!-- templates/audit_logging/audit_log_detail.html -->
{% extends 'layout/layout.html' %}
{% block content %}

<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.min.css" rel="stylesheet">

<!-- Audit Log Detail -->
<div class="container-fluid px-4 py-6">
  
  <!-- Header Section -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Audit Log Details</h1>
        <p class="text-gray-600 mt-1">Detailed view of audit log entry</p>
      </div>
      <div>
        <a href="{{ url_for('audit_logging.audit_logs') }}" 
           class="btn bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Audit Logs
        </a>
      </div>
    </div>
  </div>

  <!-- Audit Log Details -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Basic Information -->
    <div class="bg-white rounded-lg shadow-md border">
      <div class="p-6 border-b">
        <h3 class="text-lg font-semibold text-gray-800">Basic Information</h3>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-500">Log ID</label>
            <p class="mt-1 text-sm text-gray-900">{{ audit_log.id }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Timestamp</label>
            <p class="mt-1 text-sm text-gray-900">{{ audit_log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-500">User</label>
            <p class="mt-1 text-sm text-gray-900">
              {{ audit_log.user.full_name if audit_log.user else 'System' }}
              {% if audit_log.user %}
              <span class="text-gray-500">({{ audit_log.user.username }})</span>
              {% endif %}
            </p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Severity</label>
            <p class="mt-1">
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                {% if audit_log.severity == 'CRITICAL' %}bg-red-100 text-red-800
                {% elif audit_log.severity == 'ERROR' %}bg-orange-100 text-orange-800
                {% elif audit_log.severity == 'WARNING' %}bg-yellow-100 text-yellow-800
                {% else %}bg-green-100 text-green-800{% endif %}">
                {{ audit_log.severity }}
              </span>
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-500">Action</label>
            <p class="mt-1">
              <span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                {{ audit_log.action }}
              </span>
            </p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Resource Type</label>
            <p class="mt-1 text-sm text-gray-900">{{ audit_log.resource_type or 'N/A' }}</p>
          </div>
        </div>
        
        {% if audit_log.resource_id %}
        <div>
          <label class="text-sm font-medium text-gray-500">Resource ID</label>
          <p class="mt-1 text-sm text-gray-900 font-mono">{{ audit_log.resource_id }}</p>
        </div>
        {% endif %}
        
        {% if audit_log.description %}
        <div>
          <label class="text-sm font-medium text-gray-500">Description</label>
          <p class="mt-1 text-sm text-gray-900">{{ audit_log.description }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Request Information -->
    <div class="bg-white rounded-lg shadow-md border">
      <div class="p-6 border-b">
        <h3 class="text-lg font-semibold text-gray-800">Request Information</h3>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-500">IP Address</label>
          <p class="mt-1 text-sm text-gray-900 font-mono">{{ audit_log.ip_address or 'N/A' }}</p>
        </div>
        
        {% if audit_log.user_agent %}
        <div>
          <label class="text-sm font-medium text-gray-500">User Agent</label>
          <p class="mt-1 text-sm text-gray-900 break-all">{{ audit_log.user_agent }}</p>
        </div>
        {% endif %}
        
        {% if audit_log.session_id %}
        <div>
          <label class="text-sm font-medium text-gray-500">Session ID</label>
          <p class="mt-1 text-sm text-gray-900 font-mono">{{ audit_log.session_id }}</p>
        </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Data Changes -->
    {% if audit_log.old_values or audit_log.new_values %}
    <div class="bg-white rounded-lg shadow-md border lg:col-span-2">
      <div class="p-6 border-b">
        <h3 class="text-lg font-semibold text-gray-800">Data Changes</h3>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {% if audit_log.old_values %}
          <div>
            <h4 class="text-md font-medium text-gray-700 mb-3">Before (Old Values)</h4>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <pre class="text-sm text-gray-800 whitespace-pre-wrap">{{ audit_log.old_values | tojson(indent=2) }}</pre>
            </div>
          </div>
          {% endif %}
          
          {% if audit_log.new_values %}
          <div>
            <h4 class="text-md font-medium text-gray-700 mb-3">After (New Values)</h4>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <pre class="text-sm text-gray-800 whitespace-pre-wrap">{{ audit_log.new_values | tojson(indent=2) }}</pre>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Metadata -->
    {% if audit_log.meta_data %}
    <div class="bg-white rounded-lg shadow-md border lg:col-span-2">
      <div class="p-6 border-b">
        <h3 class="text-lg font-semibold text-gray-800">Metadata</h3>
      </div>
      <div class="p-6">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <pre class="text-sm text-gray-800 whitespace-pre-wrap">{{ audit_log.meta_data | tojson(indent=2) }}</pre>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

</div>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.all.min.js"></script>

<script>
// SweetAlert Toast Configuration
const Toast = Swal.mixin({
  toast: true,
  position: 'top-end',
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener('mouseenter', Swal.stopTimer)
    toast.addEventListener('mouseleave', Swal.resumeTimer)
  }
})

// Show flash messages
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    document.addEventListener('DOMContentLoaded', function() {
      {% for category, message in messages %}
        Toast.fire({
          icon: '{{ "success" if category == "success" else "error" }}',
          title: '{{ message }}'
        });
      {% endfor %}
    });
  {% endif %}
{% endwith %}
</script>

{% endblock %}
